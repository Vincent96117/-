<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HUNTER V154 | é‚è¼¯æ ¡æ­£ç‰ˆ</title>
    <style>
        body { background: #0b0e11; color: #eee; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #181a20; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #333; }
        .controls { display: flex; gap: 10px; align-items: center; }
        input { background: #2b2f36; border: 1px solid #444; color: #fff; padding: 8px 15px; border-radius: 5px; width: 200px; }
        table { width: 100%; border-collapse: collapse; background: #181a20; border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: center; border-bottom: 1px solid #2b2f36; }
        th { background: #2b2f36; color: #848e9c; font-weight: normal; font-size: 13px; }
        .row-tangling { background: rgba(0, 192, 135, 0.05) !important; border-left: 4px solid #00c087; }
        .lv-high { color: #f6465d; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.4; } }
        .score-box { background: #2b3139; color: #f0b90b; padding: 5px 12px; border-radius: 4px; font-weight: bold; font-size: 16px; border: 1px solid #444; }
        .btn { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        #btn-toggle { background: #f0b90b; color: #000; }
        #btn-sound { background: #2b3139; color: #fff; border: 1px solid #444; }
        .symbol-name { font-size: 16px; font-weight: bold; color: #fff; }
        .tp-box { color: #00c087; font-size: 12px; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <span style="font-size: 24px; font-weight: bold; color: #f0b90b;">ğŸ¯ V154 çµäººé›·é”</span>
            <span style="font-size: 12px; color: #848e9c; margin-left: 10px;">(é‚è¼¯æ ¡æº– + æœå°‹åŠŸèƒ½æ¢å¾©)</span>
        </div>
        <div class="controls">
            <input type="text" id="searchInput" placeholder="æœå°‹å¹£ç¨® (å¦‚: BTC)..." oninput="renderTable()">
            <button id="btn-sound" class="btn" onclick="toggleSound()">ğŸ”Š è²éŸ³: é–‹</button>
            <button id="btn-toggle" class="btn" onclick="toggleMonitor()">ğŸ“¡ å•Ÿå‹•æƒæ</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>é¡å‹</th>
                <th>å¹£ç¨®èˆ‡ç©ºé–“ (ATRæ¨¡å¼)</th>
                <th>ğŸš€ åŠ é€Ÿç­‰ç´š (1m)</th>
                <th>æŠ€è¡“ç¸½åˆ† (1h)</th>
                <th>è³‡è²» (Â±0.05å„ªå…ˆ)</th>
                <th>24H æ¼²è·Œ</th>
            </tr>
        </thead>
        <tbody id="list-body"></tbody>
    </table>

<script>
    let isMonitoring = false;
    let isSoundOn = true;
    let timer = null;
    let allData = [];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function toggleSound() {
        isSoundOn = !isSoundOn;
        document.getElementById('btn-sound').innerText = isSoundOn ? "ğŸ”Š è²éŸ³: é–‹" : "ğŸ”‡ è²éŸ³: é—œ";
    }

    function playBeep() {
        if (!isSoundOn) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.15);
    }

    function toggleMonitor() {
        isMonitoring = !isMonitoring;
        const btn = document.getElementById('btn-toggle');
        btn.innerText = isMonitoring ? "ğŸ›‘ åœæ­¢ç›£æ§" : "ğŸ“¡ å•Ÿå‹•æƒæ";
        btn.style.background = isMonitoring ? "#f6465d" : "#f0b90b";
        if(isMonitoring) { startScan(); timer = setInterval(startScan, 15000); }
        else { clearInterval(timer); }
    }

    async function getSymbolData(s) {
        try {
            const [tData, fRes, hK, mK] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${s}`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=25`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1m&limit=30`).then(r=>r.json())
            ]);
            
            const now = parseFloat(hK[24][4]);
            const hCloses = hK.map(k=>parseFloat(k[4]));
            const ma7 = hCloses.slice(-7).reduce((a,b)=>a+b,0)/7;
            const ma25 = hCloses.slice(-25).reduce((a,b)=>a+b,0)/25;
            
            // --- åš´æ ¼æ ¸å°ï¼š1H æŠ€è¡“ç¸½åˆ† (ä¸è®Š) ---
            const ranges = hK.map(k => parseFloat(k[2]) - parseFloat(k[3]));
            const avgR = (ranges.slice(0, 24).reduce((a,b)=>a+b,0) / 24) || 0.0001;
            
            const s1 = Math.min(25, ((parseFloat(hK[24][2]) - parseFloat(hK[24][3]))/avgR/1.8)*25); // æ³¢å‹•
            const s2 = (Math.abs(ma7-ma25)/ma25*100 < 3) ? 25 : 0; // ç³¾çµ
            const s3 = Math.min(25, (parseFloat(tData.quoteVolume)/45000000)*12.5); // é‡èƒ½ (4500è¬åŸºæº–)
            const s4 = (now > ma7 && ma7 > ma25) ? 25 : 0; // è¶¨å‹¢
            const totalScore = Math.round(s1+s2+s3+s4);

            // --- ç¨ç«‹åŠ é€Ÿ (1m) ---
            const currentVol1m = parseFloat(mK[mK.length-1][5]);
            const avgVol1m = mK.reduce((a,b)=>a+parseFloat(b[5]),0) / mK.length;
            const vRatio = avgVol1m > 0 ? (currentVol1m / avgVol1m) : 0;
            
            let thrustLv = 1;
            if(vRatio > 8.0) thrustLv = 10;
            else if(vRatio > 5.0) thrustLv = 8;
            else if(vRatio > 3.0) thrustLv = 7;
            else if(vRatio > 2.0) thrustLv = 6;
            else if(vRatio > 1.2) thrustLv = 4;
            else if(vRatio > 1.0) thrustLv = 3;

            const funding = parseFloat(fRes.lastFundingRate * 100);
            const isTangling = (funding >= -0.05 && funding <= 0.05);

            if (isMonitoring && thrustLv >= 8 && isTangling) playBeep();

            return { 
                s, totalScore, thrustLv, vRatio: vRatio.toFixed(1),
                tp: ((avgR/now)*100*2.8).toFixed(1), sl: ((avgR/now)*100*2.2).toFixed(1),
                funding, change: tData.priceChangePercent, isTangling
            };
        } catch(e) { return null; }
    }

    async function startScan() {
        const tRes = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
        const tData = await tRes.json();
        let baseSymbols = tData.filter(d => d.symbol.endsWith('USDT') && parseFloat(d.quoteVolume) > 30000000).slice(0, 40);
        
        let results = [];
        for (let d of baseSymbols) {
            const res = await getSymbolData(d.symbol);
            if (res && res.totalScore > 35) results.push(res);
        }
        allData = results.sort((a, b) => (a.isTangling === b.isTangling) ? (b.totalScore - a.totalScore) : (a.isTangling ? -1 : 1));
        renderTable();
    }

    function renderTable() {
        const search = document.getElementById('searchInput').value.toUpperCase();
        const filtered = allData.filter(d => d.s.includes(search));
        
        document.getElementById('list-body').innerHTML = filtered.map(r => `
            <tr class="${r.isTangling ? 'row-tangling' : ''}">
                <td style="color:${r.isTangling ? '#00c087' : '#848e9c'}">${r.isTangling ? 'ğŸ’ ç³¾çµ' : 'ğŸ“Š è¶¨å‹¢'}</td>
                <td>
                    <div class="symbol-name">${r.s.replace('USDT','')}</div>
                    <div class="tp-box">ğŸ¯ ${r.tp}% / -${r.sl}%</div>
                </td>
                <td class="${r.thrustLv >= 8 ? 'lv-high' : ''}" style="font-size:15px;">
                    LV ${r.thrustLv} <span style="font-size:11px;opacity:0.6;">(${r.vRatio}x)</span>
                </td>
                <td><span class="score-box">${r.totalScore}</span></td>
                <td style="color:${r.isTangling ? '#00c087' : '#eee'}; font-weight:bold;">${r.funding.toFixed(4)}%</td>
                <td style="color:${parseFloat(r.change)>=0?'#00c087':'#f6465d'}">${r.change}%</td>
            </tr>
        `).join('');
    }
</script>
</body>
</html>
