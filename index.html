<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HUNTER PRO | V142 å±±å¯¨çˆ†ç™¼é›·é”</title>
    <style>
        body { background: #000; color: #eee; font-family: 'Segoe UI', sans-serif; padding: 20px; font-size: 13px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #1c1c1c; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #333; padding: 12px; text-align: center; }
        th { background: #252525; color: #f2a900; position: sticky; top: 0; }
        .row-tangling { background: rgba(255, 68, 68, 0.2) !important; border: 2px solid #ff4444 !important; }
        .tangling-tag { background: #ff4444; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; }
        .score-box { background: #444; color: #fff; padding: 4px 10px; border-radius: 3px; font-weight: bold; font-size: 15px; }
        .score-100 { background: linear-gradient(45deg, #f2a900, #ff5500); color: #fff; box-shadow: 0 0 15px #ff5500; }
        .btn { background: #f2a900; color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .info-text { font-size: 11px; color: #aaa; line-height: 1.4; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <span style="font-size: 20px; font-weight: bold; color: #f2a900;">ğŸ¯ V142 å±±å¯¨èµ·çˆ†é›·é” (æ’é™¤å¤§å¹£)</span>
            <span id="update-time" style="margin-left: 15px; color: #888;"></span>
        </div>
        <button class="btn" onclick="toggleMonitor()" id="btn-toggle">ğŸ“¡ å•Ÿå‹•ç›£æ§</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>é¡å‹</th>
                <th>å¹£ç¨®</th>
                <th>ç¶œåˆè©•åˆ†</th>
                <th>çˆ†ç™¼æ•¸æ“š (æ³¢å‹•/é‡/ç³¾çµ)</th>
                <th>è³‡è²» (Â±0.05)</th>
                <th>24H æ¼²è·Œ</th>
            </tr>
        </thead>
        <tbody id="list-body"></tbody>
    </table>

<script>
    let isMonitoring = false;
    let timer = null;
    const EXCLUDE_LIST = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT', 'ADAUSDT'];

    function toggleMonitor() {
        isMonitoring = !isMonitoring;
        const btn = document.getElementById('btn-toggle');
        btn.innerText = isMonitoring ? "ğŸ›‘ åœæ­¢ç›£æ§" : "ğŸ“¡ å•Ÿå‹•ç›£æ§";
        btn.style.background = isMonitoring ? "#ff4444" : "#f2a900";
        if(isMonitoring) { startScan(); timer = setInterval(startScan, 10000); }
        else { clearInterval(timer); }
    }

    const getMA = (arr, p) => arr.length < p ? 0 : arr.slice(-p).reduce((a, b) => a + b, 0) / p;

    async function startScan() {
        const body = document.getElementById('list-body');
        document.getElementById('update-time').innerText = "æœ€å¾Œæ›´æ–°: " + new Date().toLocaleTimeString();
        
        try {
            const [tRes, fRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            const tData = await tRes.json();
            const fData = await fRes.json();
            const fundingMap = {};
            fData.forEach(f => { fundingMap[f.symbol] = parseFloat(f.lastFundingRate * 100).toFixed(4); });

            // æ’é™¤å¤§å¹£ + åŸºç¤é‡èƒ½éæ¿¾
            let topSymbols = tData.filter(d => 
                d.symbol.endsWith('USDT') && 
                !EXCLUDE_LIST.includes(d.symbol) &&
                parseFloat(d.quoteVolume) > 15000000
            ).sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 50);

            let results = [];

            for (let d of topSymbols) {
                const s = d.symbol;
                const hK = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=25`).then(r=>r.json());
                
                const hCloses = hK.map(k=>parseFloat(k[4]));
                const hHighs = hK.map(k=>parseFloat(k[2]));
                const hLows = hK.map(k=>parseFloat(k[3]));
                const now = hCloses[hCloses.length-1];

                // 1. æ³¢å‹•ç‡çˆ†ç™¼ (25åˆ†)
                const hourlyRanges = hHighs.map((h, i) => h - hLows[i]);
                const avgRange = hourlyRanges.slice(0, -1).reduce((a,b)=>a+b,0) / 24;
                const currentRange = hourlyRanges[hourlyRanges.length-1];
                const volaRatio = currentRange / (avgRange || 1);
                let volaSScore = Math.min(25, (volaRatio / 2) * 25);

                // 2. å‡ç·šç³¾çµèˆ‡ç«™ä¸Š (25åˆ†)
                const ma7 = getMA(hCloses, 7);
                const ma25 = getMA(hCloses, 25);
                const hDiff = Math.abs(ma7 - ma25) / ma25 * 100;
                let tangleScore = (hDiff < 3) ? (25 * (1 - hDiff/3)) : 0;
                if (now < ma7 || now < ma25) tangleScore *= 0.5; // æœªç«™ä¸Šæ¸›åŠ

                // 3. é‡æ¯” (25åˆ†)
                const totalVol = parseFloat(d.quoteVolume);
                const avgVolHourly = totalVol / 24;
                const lastVol = parseFloat(d.lastQty) * parseFloat(d.lastPrice); // æ¦‚ç®—ç•¶ä¸‹é‡
                const volRatio = (totalVol / 30000000); // é€™è£¡ç¶­æŒä¸€å€‹å¸‚å ´æ´»èºåº¦åŸºæº–
                let vScore = Math.min(25, volRatio * 8);

                // 4. é«˜é»ä½ç½® (25åˆ†)
                const recentHigh = Math.max(...hHighs.slice(-4));
                const distToHigh = Math.abs(now - recentHigh) / recentHigh * 100;
                let highScore = (distToHigh < 3) ? 25 : (distToHigh < 5 ? 10 : 0);

                let finalScore = Math.round(volaSScore + tangleScore + vScore + highScore);
                const funding = parseFloat(fundingMap[s] || 0);
                const isTangling = (funding >= -0.05 && funding <= 0.05);

                if (finalScore >= 35) {
                    results.push({
                        symbol: s.replace('USDT',''),
                        score: Math.min(100, finalScore),
                        funding: funding,
                        isTangling: isTangling,
                        info: `æ³¢:${volaRatio.toFixed(1)}x|ç³¾:${hDiff.toFixed(1)}%|é‡:${volRatio.toFixed(1)}x`,
                        change: d.priceChangePercent
                    });
                }
            }

            results.sort((a, b) => {
                if (a.isTangling && !b.isTangling) return -1;
                if (!a.isTangling && b.isTangling) return 1;
                return b.score - a.score;
            });

            body.innerHTML = results.map(r => `
                <tr class="${r.isTangling ? 'row-tangling' : ''}">
                    <td>${r.isTangling ? '<span class="tangling-tag">ç³¾çµçªç ´</span>' : 'ä¸€èˆ¬'}</td>
                    <td style="font-weight:bold; font-size:14px;">${r.symbol}</td>
                    <td><span class="score-box ${r.score >= 85 ? 'score-100' : ''}">${r.score}</span></td>
                    <td class="info-text">${r.info}</td>
                    <td style="font-weight:bold;">${r.funding}%</td>
                    <td style="color:${parseFloat(r.change)>=0 ? '#00ffcc':'#ff6666'}">${r.change}%</td>
                </tr>
            `).join('');
        } catch (e) { console.error(e); }
    }
</script>
</body>
</html>
