<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HUNTER V172 | è„«é‰¤åµæ¸¬å®Œå…¨é«”</title>
    <style>
        body { background: radial-gradient(circle at top, #1a1c2c, #0d0e15); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 20px; font-size: 13px; min-height: 100vh; margin: 0; }
        .header { background: rgba(30, 34, 54, 0.9); padding: 18px; border-radius: 12px; border: 1px solid #3d4465; margin: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); }
        .monitor-bar { display: flex; gap: 35px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #3d4465; }
        .index-item { display: flex; align-items: center; gap: 12px; }
        .index-name { color: #f2a900; font-weight: bold; font-size: 14px; }
        .index-price { font-family: 'Consolas', monospace; font-size: 19px; font-weight: bold; color: #ffffff; }
        .controls { display: flex; justify-content: space-between; align-items: center; }
        table { width: calc(100% - 40px); border-collapse: separate; border-spacing: 0 6px; margin: 0 20px 20px 20px; }
        th { background: #161925; color: #f2a900; padding: 16px; border-bottom: 2px solid #3d4465; text-transform: uppercase; }
        td { background: #1e2236; padding: 14px; text-align: center; border-top: 1px solid #2d3250; border-bottom: 1px solid #2d3250; transition: 0.3s; }
        .row-tangling td { background: #1e2c36 !important; border-top-color: #00ffcc66; border-bottom-color: #00ffcc66; }
        .row-tangling td:first-child { border-left: 5px solid #00ffcc; border-radius: 4px 0 0 4px; }
        .score-box { padding: 8px 16px; border-radius: 6px; font-weight: 900; font-size: 20px; border: 1px solid #444; display: inline-block; }
        .score-alert { color: #ff3e3e; background: #3a1a1a; border-color: #ff3e3e; box-shadow: 0 0 15px #ff3e3e; animation: alert-blink 0.6s infinite; }
        .lv-high { color: #ff5252; font-weight: bold; text-shadow: 0 0 10px #ff5252; animation: blink 1s infinite; }
        @keyframes alert-blink { 50% { opacity: 0.6; transform: scale(1.05); } }
        @keyframes blink { 50% { opacity: 0.6; } }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        input { background: #2d3250; border: 1px solid #3d4465; color: #fff; padding: 10px 14px; border-radius: 8px; width: 200px; }
        .del-btn { color: #666; cursor: pointer; font-size: 20px; font-weight: bold; }
        .info-tag { font-size: 11px; color: #aaa; display: block; margin-top: 5px; }
        .decouple-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .tag-independent { background: #00ffcc22; color: #00ffcc; border: 1px solid #00ffcc; }
        .tag-follow { background: #444; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <div class="monitor-bar">
            <div class="index-item"><span class="index-name">BTC</span><span id="btc-price" class="index-price">--</span><span id="btc-chg">--</span></div>
            <div class="index-item"><span class="index-name">ETH</span><span id="eth-price" class="index-price">--</span><span id="eth-chg">--</span></div>
        </div>
        <div class="controls">
            <div class="search-group">
                <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å¹£ç¨®..." onkeydown="if(event.key==='Enter') searchFromBinance()">
                <button class="btn" onclick="searchFromBinance()" style="background:#3d4465; color:#fff;">æœå°‹å¹£å®‰</button>
                <button id="btn-sound" class="btn" onclick="toggleSound()" style="background:#2d3250;color:#eee;">ğŸ”Š è²éŸ³: é–‹</button>
            </div>
            <button id="btn-toggle" class="btn" onclick="toggleMonitor()" style="background:#f2a900;color:#000;">å•Ÿå‹•ç›£æ§æƒæ</button>
        </div>
    </div>

    <table>
        <thead>
            <tr><th width="50">âœ•</th><th width="100">ç‹€æ…‹</th><th>å¹£ç¨® / ATRå€é–“</th><th>ğŸš€ è¡åˆºç­‰ç´š (ç·©é™)</th><th>æŠ€è¡“ç¸½åˆ†</th><th>è³‡è²» (Â±0.05)</th><th>è¡Œæƒ…æ€§è³ª (å»é€£å‹•)</th></tr>
        </thead>
        <tbody id="list-body"></tbody>
    </table>

<script>
    let isMonitoring = false, isSoundOn = true, timer = null, rawResults = [], blackList = new Set();
    let lvMemory = {}, btcPrevPrice = 0, btcDirection = 0; 
    const hideList = ["BTCUSDT", "ETHUSDT", "SOLUSDT", "XRPUSDT", "BNBUSDT", "BNXUSDT"];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function toggleSound() { isSoundOn = !isSoundOn; document.getElementById('btn-sound').innerText = isSoundOn ? "ğŸ”Š è²éŸ³: é–‹" : "ğŸ”‡ è²éŸ³: é—œ"; }
    function playBeep() { if (!isSoundOn) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.frequency.setValueAtTime(1000, audioCtx.currentTime); g.gain.setValueAtTime(0.05, audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.1); }

    async function updateIndex() {
        try {
            const symbols = ['BTCUSDT', 'ETHUSDT'];
            for (const s of symbols) {
                const r = await fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(res => res.json());
                const id = s.replace('USDT','').toLowerCase();
                const curPrice = parseFloat(r.lastPrice);
                if (s === 'BTCUSDT') {
                    btcDirection = curPrice > btcPrevPrice ? 1 : (curPrice < btcPrevPrice ? -1 : 0);
                    btcPrevPrice = curPrice;
                }
                const chg = parseFloat(r.priceChangePercent);
                document.getElementById(`${id}-price`).innerText = curPrice.toLocaleString();
                document.getElementById(`${id}-chg`).innerText = `${chg > 0 ? '+' : ''}${chg}%`;
                document.getElementById(`${id}-chg`).style.color = chg >= 0 ? '#00ffcc' : '#ff5252';
            }
        } catch(e) {}
    }
    setInterval(updateIndex, 3000); updateIndex();

    function removeSymbol(s) { blackList.add(s); rawResults = rawResults.filter(r => r.s !== s); renderTable(); }

    async function searchFromBinance() {
        let symbol = document.getElementById('search-input').value.toUpperCase().trim();
        if(!symbol) return;
        if(!symbol.endsWith('USDT')) symbol += 'USDT';
        blackList.delete(symbol);
        const res = await getSymbolData(symbol);
        if(res) { rawResults = [res, ...rawResults.filter(r => r.s !== symbol)]; renderTable(); document.getElementById('search-input').value = ""; }
    }

    async function getSymbolData(s) {
        try {
            const [tData, fRes, hK, mK] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${s}`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=25`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1m&limit=2`).then(r=>r.json())
            ]);
            const now = parseFloat(hK[24][4]), hCloses = hK.map(k=>parseFloat(k[4]));
            const ma7 = hCloses.slice(-7).reduce((a,b)=>a+b,0)/7, ma25 = hCloses.slice(-25).reduce((a,b)=>a+b,0)/25;
            const min4h = Math.min(...hK.slice(20, 24).map(k => parseFloat(k[3])));
            const ranges = hK.map(k => parseFloat(k[2]) - parseFloat(k[3])), avgR = (ranges.slice(0, 24).reduce((a,b)=>a+b,0) / 24) || 0.001;
            
            // åŸºç¤æŒ‡æ¨™åˆ†
            const s1 = Math.min(25, ((parseFloat(hK[24][2]) - parseFloat(hK[24][3]))/avgR/1.8)*25);
            const s2 = (Math.abs(ma7-ma25)/ma25*100 < 3) ? 25 : 0;
            const s3 = Math.min(25, (parseFloat(tData.quoteVolume)/15000000)*12.5);
            const s4 = (now > ma7 && ma7 > ma25) ? 25 : 0;
            
            let totalScore = Math.round(s1 + s2 + s3 + s4);

            // ç¨ç«‹æ€§åµæ¸¬ (æ ¸å¿ƒé‚è¼¯ä¿®æ­£)
            const coinDirection = now > parseFloat(mK[0][4]) ? 1 : -1;
            let decoupleStatus = "è¯å‹•";
            // ä¿®æ­£ï¼šç•¶ BTC ä¸‹è·Œ/ç›¤æ•´ï¼Œå°å¹£å‘ä¸Šèµ°ï¼Œåˆ¤å®šç‚ºç¨ç«‹
            if (btcDirection <= 0 && coinDirection === 1) {
                totalScore += 20; 
                decoupleStatus = "âš¡ ç¨ç«‹";
            } else if (btcDirection === 1 && coinDirection === 1) {
                decoupleStatus = "è·Ÿéš¨";
            }

            if (now < min4h) totalScore = 0; // 4Hä¿éšªçµ²

            // LV ç·©é™æ©Ÿåˆ¶
            const totalVol1m = parseFloat(tData.quoteVolume) / 1440; // ç°¡åŒ–ä¼°è¨ˆ
            let curThrust = (totalScore > 60) ? Math.floor(totalScore/10) : 1;
            if (!lvMemory[s]) lvMemory[s] = 1;
            if (curThrust > lvMemory[s]) lvMemory[s] = curThrust;
            else if (lvMemory[s] > 1) lvMemory[s] -= 1;
            let thrustLv = lvMemory[s];

            const funding = parseFloat(fRes.lastFundingRate * 100);
            const isTangling = (funding >= -0.05 && funding <= 0.05);
            if (isMonitoring && thrustLv >= 8 && isTangling) playBeep();
            
            return { s, totalScore, thrustLv, tp: ((avgR/now)*100*2.8).toFixed(1), sl: ((avgR/now)*100*2.2).toFixed(1), funding, change: tData.priceChangePercent, decoupleStatus, isTangling };
        } catch(e) { return null; }
    }

    async function startScan() {
        if (!isMonitoring) return;
        const tData = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        let baseSymbols = tData.filter(d => d.symbol.endsWith('USDT') && parseFloat(d.quoteVolume) > 10000000).sort((a,b)=>b.quoteVolume-a.quoteVolume).slice(0, 50);
        let results = [];
        for (let d of baseSymbols) {
            if(blackList.has(d.symbol) || hideList.includes(d.symbol)) continue;
            const res = await getSymbolData(d.symbol);
            if (res && res.totalScore > 30) results.push(res); 
        }
        rawResults = results.sort((a, b) => b.totalScore - a.totalScore);
        renderTable();
    }

    function toggleMonitor() {
        isMonitoring = !isMonitoring;
        const btn = document.getElementById('btn-toggle');
        btn.innerText = isMonitoring ? "ğŸ›‘ åœæ­¢ç›£æ§" : "å•Ÿå‹•ç›£æ§æƒæ";
        btn.style.background = isMonitoring ? "#ff5252" : "#f2a900";
        if(isMonitoring) { startScan(); timer = setInterval(startScan, 15000); } else { clearInterval(timer); }
    }

    function renderTable() {
        document.getElementById('list-body').innerHTML = rawResults.map(r => `
            <tr class="${r.isTangling ? 'row-tangling' : ''}">
                <td><span class="del-btn" onclick="removeSymbol('${r.s}')">âœ•</span></td>
                <td>${r.isTangling ? 'ğŸ’ æ½›ä¼' : 'ğŸ“Š è¶¨å‹¢'}</td>
                <td style="font-weight:bold; color:#fff;">${r.s.replace('USDT','')}<span class="info-tag">ğŸ¯ ${r.tp}% / -${r.sl}%</span></td>
                <td class="${r.thrustLv >= 8 ? 'lv-high' : ''}">LV ${r.thrustLv}</td>
                <td><span class="score-box ${r.totalScore >= 80 ? 'score-alert' : 'score-normal'}">${r.totalScore}</span></td>
                <td style="color:${r.isTangling ? '#00ffcc' : '#eee'}; font-weight:bold;">${r.funding.toFixed(4)}%</td>
                <td><span class="decouple-tag ${r.decoupleStatus.includes('âš¡') ? 'tag-independent' : 'tag-follow'}">${r.decoupleStatus}</span><span class="info-tag">${r.change}%</span></td>
            </tr>`).join('');
    }
</script>
</body>
</html>
