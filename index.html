<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HUNTER V177 | TP/SL ç®—æ³•å›æ­¸ç‰ˆ</title>
    <style>
        body { background: radial-gradient(circle at top, #1a1c2c, #0d0e15); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; padding: 20px; font-size: 13px; min-height: 100vh; margin: 0; }
        .header { background: rgba(30, 34, 54, 0.9); padding: 18px; border-radius: 12px; border: 1px solid #3d4465; margin: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); }
        .monitor-bar { display: flex; gap: 35px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #3d4465; }
        .index-item { display: flex; align-items: center; gap: 12px; }
        .index-name { color: #f2a900; font-weight: bold; font-size: 14px; }
        .index-price { font-family: 'Consolas', monospace; font-size: 19px; font-weight: bold; color: #ffffff; }
        .index-chg { font-weight: bold; font-size: 14px; }
        .controls { display: flex; justify-content: space-between; align-items: center; }
        .search-group { display: flex; gap: 12px; align-items: center; }
        table { width: calc(100% - 40px); border-collapse: separate; border-spacing: 0 6px; margin: 0 20px 20px 20px; }
        th { background: #161925; color: #f2a900; padding: 16px; border-bottom: 2px solid #3d4465; text-transform: uppercase; }
        td { background: #1e2236; padding: 14px; text-align: center; border-top: 1px solid #2d3250; border-bottom: 1px solid #2d3250; transition: 0.3s; }
        .row-strong td { background: #1a2f2a !important; border-top-color: #00ffcc99; border-bottom-color: #00ffcc99; }
        .row-strong td:first-child { border-left: 5px solid #00ffcc; border-radius: 4px 0 0 4px; }
        .score-box { padding: 8px 16px; border-radius: 6px; font-weight: 900; font-size: 20px; border: 1px solid #444; display: inline-block; }
        .score-normal { color: #f2a900; background: #2a2a2a; border-color: #f2a900; }
        .score-alert { color: #ff3e3e; background: #3a1a1a; border-color: #ff3e3e; box-shadow: 0 0 15px #ff3e3e; animation: alert-blink 0.6s infinite; }
        @keyframes alert-blink { 50% { opacity: 0.6; transform: scale(1.05); } }
        .lv-high { color: #ff5252; font-weight: bold; text-shadow: 0 0 10px #ff5252; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }
        .light-bar { display: flex; justify-content: center; gap: 8px; margin-top: 8px; }
        .light-unit { display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .light-label { font-size: 9px; color: #999; font-weight: bold; }
        .light { width: 16px; height: 6px; border-radius: 2px; }
        .light-green { background: #00ffcc; box-shadow: 0 0 8px #00ffcc; }
        .light-yellow { background: #f2a900; }
        .light-red { background: #ff5252; }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        input { background: #2d3250; border: 1px solid #3d4465; color: #fff; padding: 10px 14px; border-radius: 8px; width: 220px; }
        .del-btn { color: #666; cursor: pointer; font-size: 20px; font-weight: bold; }
        .info-tag { font-size: 11px; color: #aaa; display: block; margin-top: 5px; }
        .tp-text { color: #00ffcc; font-weight: bold; }
        .sl-text { color: #ff5252; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div class="monitor-bar">
            <div class="index-item"><span class="index-name">BTC</span><span id="btc-price" class="index-price">--</span><span id="btc-chg" class="index-chg">--</span></div>
            <div class="index-item"><span class="index-name">ETH</span><span id="eth-price" class="index-price">--</span><span id="eth-chg" class="index-chg">--</span></div>
        </div>
        <div class="controls">
            <div class="search-group">
                <input type="text" id="search-input" placeholder="ğŸ” æœå°‹é»‘é¦¬(è‡ªå‹•æ’é™¤å‰25å¸‚å€¼)..." onkeydown="if(event.key==='Enter') searchFromBinance()">
                <button class="btn" onclick="searchFromBinance()" style="background:#3d4465; color:#fff;">æœå°‹å¹£å®‰</button>
            </div>
            <button id="btn-toggle" class="btn" onclick="toggleMonitor()" style="background:#f2a900;color:#000;">å•Ÿå‹•ç›£æ§æƒæ</button>
        </div>
    </div>

    <table>
        <thead>
            <tr><th width="50">âœ•</th><th width="100">é¡å‹</th><th>å¹£ç¨® / ATR å»ºè­°</th><th>ğŸš€ è¡åˆºç­‰ç´š (å›æ¸¬)</th><th>æŠ€è¡“ç¸½åˆ† (æ¬Šé‡)</th><th>è³‡è²» (Â±0.05)</th><th>24H æ¼²è·Œ</th></tr>
        </thead>
        <tbody id="list-body"></tbody>
    </table>

<script>
    let isMonitoring = false, timer = null, rawResults = [], blackList = new Set();
    let lvMemory = {}, btcKlines = []; 
    const top25Exclude = ["BTCUSDT", "ETHUSDT", "USDTUSDT", "BNBUSDT", "SOLUSDT", "USDCUSDT", "XRPUSDT", "ADAUSDT", "STETHUSDT", "DOGEUSDT", "AVAXUSDT", "TRXUSDT", "DOTUSDT", "LINKUSDT", "TONUSDT", "SHIBUSDT", "MATICUSDT", "POLUSDT", "WBTCUSDT", "DAIUSDT", "LTCUSDT", "BCHUSDT", "NEARUSDT", "UNIUSDT", "ICPUSDT", "BNXUSDT", "BNXUSDT"];

    async function updateIndex() {
        try {
            const symbols = ['BTCUSDT', 'ETHUSDT'];
            for (const s of symbols) {
                const r = await fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(res => res.json());
                const id = s.replace('USDT','').toLowerCase();
                const chg = parseFloat(r.priceChangePercent);
                document.getElementById(`${id}-price`).innerText = parseFloat(r.lastPrice).toLocaleString();
                document.getElementById(`${id}-chg`).innerText = `${chg >= 0 ? '+' : ''}${chg}%`;
                document.getElementById(`${id}-chg`).style.color = chg >= 0 ? '#00ffcc' : '#ff5252';
            }
            btcKlines = await fetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1h&limit=2').then(r=>r.json());
        } catch(e) {}
    }
    setInterval(updateIndex, 3000); updateIndex();

    async function getSymbolData(s) {
        try {
            const [tData, fRes, hK, mK] = await Promise.all([
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${s}`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=25`).then(r=>r.json()),
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1m&limit=60`).then(r=>r.json())
            ]);
            const now = parseFloat(hK[24][4]), hCloses = hK.map(k=>parseFloat(k[4]));
            const min4h = Math.min(...hK.slice(20, 24).map(k => parseFloat(k[3])));
            const ma7 = hCloses.slice(-7).reduce((a,b)=>a+b,0)/7, ma25 = hCloses.slice(-25).reduce((a,b)=>a+b,0)/25;
            
            // --- V169 ATR ç®—æ³•å›æ­¸ ---
            const ranges = hK.map(k => parseFloat(k[2]) - parseFloat(k[3]));
            const avgR = (ranges.slice(0, 24).reduce((a,b)=>a+b,0) / 24) || 0.001;
            const v169_tp = ((avgR * 2.8) / now * 100).toFixed(1);
            const v169_sl = ((avgR * 2.2) / now * 100).toFixed(1);

            // --- è„«é‰¤åŠ åˆ† ---
            let weight = 0, type = "ğŸ“Š è¶¨å‹¢";
            if (btcKlines.length >= 2) {
                const btcChg = (parseFloat(btcKlines[1][4]) - parseFloat(btcKlines[0][4])) / parseFloat(btcKlines[0][4]);
                const altChg = (now - parseFloat(hK[23][4])) / parseFloat(hK[23][4]);
                if (altChg > 0.02 && btcChg <= 0) { weight = 20; type = "ğŸš€ å¼·åŠ›è„«é‰¤"; }
                else if (altChg > 0.01 && altChg > btcChg) { weight = 10; type = "ğŸ’ ç¨ç«‹"; }
                else if (altChg < -0.01 && btcChg >= 0) { weight = -20; type = "ğŸ“‰ å¼±å‹¢"; }
            }

            const s1 = Math.min(25, ((parseFloat(hK[24][2]) - parseFloat(hK[24][3]))/avgR/1.8)*25);
            const s2 = (Math.abs(ma7-ma25)/ma25*100 < 3) ? 25 : 0;
            const s3 = Math.min(25, (parseFloat(tData.quoteVolume)/30000000)*12.5);
            const s4 = (now > ma7 && ma7 > ma25) ? 25 : 0;
            
            let totalScore = Math.round(s1 + s2 + s3 + s4) + weight;
            if (now < min4h) totalScore = 0;

            const vRatio = parseFloat(mK[59][5]) / (mK.reduce((a,b)=>a+parseFloat(b[5]),0) / 60);
            const buyRatio = (parseFloat(mK[59][9]) / parseFloat(mK[59][5])) * 100;
            let curThrust = (vRatio > 1.2 && now >= parseFloat(mK[58][4])) ? Math.max(2, Math.min(10, Math.round(vRatio * 1.8 + (buyRatio > 65 ? 3 : 0)))) : 1;
            if (!lvMemory[s]) lvMemory[s] = 1;
            lvMemory[s] = curThrust > lvMemory[s] ? curThrust : Math.max(1, lvMemory[s] - 1);

            const funding = parseFloat(fRes.lastFundingRate * 100);
            const isTangling = (funding >= -0.05 && funding <= 0.05);
            if (isTangling && weight >= 0) type = "ğŸ’ æ½›ä¼";

            return { s, totalScore, scores:[s1,s2,s3,s4], labels:['æ³¢','ç³¾','é‡','è¶¨'], thrustLv:lvMemory[s], vRatio:vRatio.toFixed(1), buyRatio:buyRatio.toFixed(0), tp:v169_tp, sl:v169_sl, funding, change:tData.priceChangePercent, isTangling, weight };
        } catch(e) { return null; }
    }

    async function startScan() {
        if (!isMonitoring) return;
        const tData = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r=>r.json());
        let baseSymbols = tData.filter(d => d.symbol.endsWith('USDT') && parseFloat(d.quoteVolume) > 10000000).sort((a,b)=>b.quoteVolume-a.quoteVolume).slice(0, 80);
        let results = [];
        for (let d of baseSymbols) {
            if(blackList.has(d.symbol) || top25Exclude.includes(d.symbol)) continue;
            const res = await getSymbolData(d.symbol);
            if (res && res.totalScore > 30) results.push(res); 
        }
        rawResults = results.sort((a, b) => b.totalScore - a.totalScore);
        renderTable();
    }

    function toggleMonitor() {
        isMonitoring = !isMonitoring;
        const btn = document.getElementById('btn-toggle');
        btn.innerText = isMonitoring ? "ğŸ›‘ åœæ­¢ç›£æ§" : "å•Ÿå‹•ç›£æ§æƒæ";
        btn.style.background = isMonitoring ? "#ff5252" : "#f2a900";
        if(isMonitoring) { startScan(); timer = setInterval(startScan, 15000); } else { clearInterval(timer); }
    }

    function renderTable() {
        document.getElementById('list-body').innerHTML = rawResults.map(r => `
            <tr class="${r.weight >= 20 ? 'row-strong' : (r.weight < 0 ? 'row-weak' : '')}">
                <td><span class="del-btn" onclick="removeSymbol('${r.s}')">âœ•</span></td>
                <td>${r.weight >= 20 ? 'ğŸš€ å¼·åŠ›è„«é‰¤' : (r.isTangling ? 'ğŸ’ æ½›ä¼' : 'ğŸ“Š è¶¨å‹¢')}</td>
                <td style="font-weight:bold; color:#fff;">${r.s.replace('USDT','')}<br><span class="info-tag"><span class="tp-text">TP +${r.tp}%</span> / <span class="sl-text">SL -${r.sl}%</span></span></td>
                <td class="${r.thrustLv >= 8 ? 'lv-high' : ''}">LV ${r.thrustLv}<span class="info-tag">${r.vRatio}x / ${r.buyRatio}%</span></td>
                <td><span class="score-box ${r.totalScore >= 80 ? 'score-alert' : 'score-normal'}">${r.totalScore}</span><div class="light-bar">${r.scores.map((s, i) => `<div class="light-unit"><span class="light-label">${r.labels[i]}</span><div class="light ${s >= 25 ? 'light-green' : (s >= 12.5 ? 'light-yellow' : 'light-red')}"></div></div>`).join('')}</div></td>
                <td style="color:${Math.abs(r.funding) <= 0.05 ? '#00ffcc' : '#eee'}; font-weight:bold;">${r.funding.toFixed(4)}%</td>
                <td style="color:#00ffcc">${r.change}%</td>
            </tr>`).join('');
    }
    function removeSymbol(s) { blackList.add(s); rawResults = rawResults.filter(r => r.s !== s); renderTable(); }
    function searchFromBinance() {
        let s = document.getElementById('search-input').value.toUpperCase().trim();
        if(!s) return; if(!s.endsWith('USDT')) s += 'USDT';
        blackList.delete(s);
        getSymbolData(s).then(res => { if(res){ rawResults=[res,...rawResults.filter(r=>r.s!==s)]; renderTable(); } });
    }
</script>
</body>
</html>
