<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>V84.4 çµäººçµ‚æ¥µé‡èƒ½ç‰ˆ</title>
    <style>
        :root { --bg: #000; --card: #111; --border: #333; --text: #eee; --surge: #3fb950; --fall: #f85149; --strong: #58a6ff; --alert: #ff6600; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 0; margin: 0; font-size: 11px; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .top-calendar { height: 160px; border-bottom: 2px solid #444; background: #000; }
        .header-main { display: flex; align-items: center; justify-content: space-between; background: #161b22; padding: 4px 12px; height: 32px; border-bottom: 1px solid var(--border); }
        .container { display: grid; grid-template-columns: 1fr 1fr 1.1fr 1.6fr; gap: 4px; flex: 1; padding: 4px; box-sizing: border-box; overflow: hidden; }
        .card { background: #0d1117; border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; overflow: hidden; }
        h2 { font-size: 0.85rem; padding: 8px; margin: 0; background: #161b22; border-bottom: 1px solid var(--border); text-align: center; }
        .scroll { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        td { padding: 8px 2px; border-bottom: 1px solid #21262d; text-align: center; }
        .funding-high { background: #a6611a !important; color: white !important; font-weight: bold; }
        .funding-tag { font-size: 9px; padding: 1px 3px; border-radius: 2px; margin-left: 2px; }
        @keyframes blink-red { 0% { background: transparent; } 50% { background: #f8514933; } 100% { background: transparent; } }
        .pot-alert { animation: blink-red 1s infinite; border: 1px solid var(--fall) !important; }
    </style>
</head>
<body>

<div class="header-main">
    <div style="font-weight:bold; font-size:12px;">
        <span style="color:#f2a900">BTC: <span id="btc-live">--</span></span> | 
        <span style="color:#627eea">ETH: <span id="eth-live">--</span></span>
    </div>
    <div style="color:var(--strong); font-weight:bold;">V84.4 çµäººç‰ˆ | 3æ—¥å‡é‡å°æ¯”é‚è¼¯</div>
    <button onclick="location.reload()" style="cursor:pointer; padding: 2px 8px;">ğŸ”„ åˆ·æ–°ç³»çµ±</button>
</div>

<div class="top-calendar">
    <iframe src="https://www.tradingview-widget.com/embed-widget/events/?locale=zh_TW&currencyFilter=USD&importanceFilter=0%2C1" style="width:100%; height:100%; border:none;"></iframe>
</div>

<div class="container">
    <div class="card"><h2 style="color:var(--surge)">ğŸš€ ç¬é–“å™´ç™¼</h2><div class="scroll"><table><tbody id="surge-list"></tbody></table></div></div>
    <div class="card"><h2 style="color:var(--strong)">ğŸ”¥ é«˜æª”å¼·å‹¢</h2><div class="scroll"><table><tbody id="strong-list"></tbody></table></div></div>
    <div class="card"><h2 style="color:var(--fall)">âš ï¸ è³‡é‡‘è²»ç‡</h2><div class="scroll"><table><tbody id="fund-list"></tbody></table></div></div>
    <div class="card">
        <h2 style="color:#bc8cff">ğŸ’ æ½›åŠ›ç›£æ§ (3æ—¥æ”¾é‡å°æ¯”)</h2>
        <div class="scroll"><table><thead><tr><th style="width:45%">å¹£ç¨®</th><th>è©•åˆ†</th><th>ç‹€æ…‹</th><th>âœ•</th></tr></thead><tbody id="potential-list"></tbody></table></div>
    </div>
</div>

<script>
    const MY_BARK_KEY = 'KQP2fTbTfPp4HnhQSYNaxH';
    let btcChange = 0, fundingMap = {}, dataMap = {}, lockedPotList = [], pushed80 = new Set();

    // æŠ“å–éå» 3 å¤©çš„å¹³å‡æˆäº¤é‡åŸºæº–
    async function getBaseVolume(symbol) {
        try {
            const res = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}USDT&interval=4h&limit=18`); // 18å€‹4H = 3å¤©
            const data = await res.json();
            let totalVol = 0;
            data.forEach(k => totalVol += parseFloat(k[7])); // k[7] æ˜¯æˆäº¤é¡ (quote volume)
            return totalVol / data.length; // å›å‚³ 4H çš„å¹³å‡æˆäº¤é¡åŸºæº–
        } catch(e) { return 1000000; } // å¤±æ•—å‰‡çµ¦å€‹ä¿åº•é–€æª»
    }

    async function updateFunding() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
            const data = await res.json();
            const list = document.getElementById('fund-list');
            list.innerHTML = '';
            let filtered = [];
            data.forEach(f => {
                const s = f.symbol.replace('USDT',''), r = parseFloat(f.lastFundingRate)*100;
                fundingMap[s] = r;
                if(Math.abs(r) >= 0.05) filtered.push({s, r});
            });
            filtered.sort((a,b) => Math.abs(b.r)-Math.abs(a.r)).slice(0,12).forEach(f => {
                list.insertAdjacentHTML('beforeend', `<tr><td>${f.s}</td><td class="funding-high">${f.r.toFixed(4)}%</td></tr>`);
            });
        } catch(e) {}
    }

    function connectWS() {
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');
        ws.onmessage = async (e) => {
            const tickers = JSON.parse(e.data);
            for (let d of tickers) {
                if(d.s.endsWith('USDT')) {
                    const s = d.s.replace('USDT',''), p = parseFloat(d.c), p24 = parseFloat(d.P), vol = parseFloat(d.q), h = parseFloat(d.h), l = parseFloat(d.l), range = ((h-l)/l)*100;
                    
                    if(s==='BTC') { btcChange=p24; document.getElementById('btc-live').innerText=`${p} (${p24}%)`; }
                    if(s==='ETH') document.getElementById('eth-live').innerText=`${p} (${p24}%)`;
                    
                    if(!dataMap[s]) {
                        dataMap[s] = {lp:p, avg4hVol: 0};
                        dataMap[s].avg4hVol = await getBaseVolume(s); // åˆå§‹åŒ–æŠ“å–3å¤©å‡é‡
                    }
                    
                    // é«˜æª”å¼·å‹¢
                    const sList = document.getElementById('strong-list');
                    let r = [...sList.querySelectorAll('tr')].find(x => x.innerHTML.includes(s));
                    if (p24 > 8.0) {
                        if (!r) sList.insertAdjacentHTML('beforeend', `<tr><td>${s}</td><td style="color:var(--surge)">${p24}%</td></tr>`);
                        else r.cells[1].innerText = `${p24}%`;
                    } else if (r) r.remove();

                    // ç¬é–“å™´ç™¼
                    const inst = ((p-dataMap[s].lp)/dataMap[s].lp)*100;
                    if(inst>=1.2) {
                        const b = document.getElementById('surge-list');
                        b.insertAdjacentHTML('afterbegin', `<tr><td>${s}</td><td style="color:var(--surge)">+${inst.toFixed(2)}%</td></tr>`);
                        if(b.children.length>15) b.lastElementChild.remove();
                    }

                    // æ½›åŠ›å¹£ 60/80ï¼š3æ—¥å‡é‡ vs å³æ™‚4Hé€Ÿ
                    if(vol > 5000000 && p24 >= 1.0 && p24 <= 5.0 && range <= 6.5) {
                        const rsScore = (p24 - btcChange) > 0 ? Math.min(40, (p24 - btcChange) * 10) : 0;
                        const sqScore = Math.max(0, Math.min(30, (6.5 - range) * 5));
                        
                        // é‡èƒ½æ¯”ç®—æ³•ï¼šç•¶å‰24hé‡é™¤ä»¥6ï¼Œç´„ç•¥ç­‰æ–¼ç•¶å‰4hé«”æ„Ÿé‡ï¼Œå†å°æ¯”3æ—¥å‡é‡
                        const current4hSpeed = vol / 6; 
                        const volRatio = current4hSpeed / dataMap[s].avg4hVol;
                        const volScore = Math.min(30, (volRatio / 2) * 20); // 2å€å‡é‡å³æ‹¿20åˆ†
                        
                        const score = Math.min(100, Math.round(rsScore + sqScore + volScore));
                        if (score >= 60) updatePot({s, score});
                    }
                    dataMap[s].lp=p;
                }
            }
        };
    }

    function updatePot(c) {
        let item = lockedPotList.find(i=>i.s===c.s);
        if(!item && lockedPotList.length < 10) { item = c; lockedPotList.push(item); }
        if(item) {
            item.score = c.score;
            if(item.score >= 80 && !pushed80.has(item.s)) {
                fetch(`https://api.day.app/${MY_BARK_KEY}/ğŸ¯å‡é‡çˆ†ç™¼/${item.s}-${item.score}åˆ†?group=HunterPot`);
                pushed80.add(item.s);
            }
        }
        const list = document.getElementById('potential-list'); list.innerHTML = '';
        lockedPotList.sort((a,b)=>b.score-a.score).forEach(it => {
            const fr = fundingMap[it.s] || 0;
            const frClass = Math.abs(fr) >= 0.05 ? 'funding-high' : '';
            list.insertAdjacentHTML('beforeend', `<tr class="${it.score>=80?'pot-alert':''}"><td>${it.s} <span class="funding-tag ${frClass}">${fr.toFixed(3)}%</span></td><td style="color:var(--alert);font-weight:bold">${it.score}</td><td>${it.score>=80?'æ”¾é‡é«”æª¢':'è§€å¯Ÿ'}</td><td><button style="border:none;background:transparent;color:#666;cursor:pointer" onclick="lockedPotList=lockedPotList.filter(i=>i.s!=='${it.s}');pushed80.delete('${it.s}');">âœ•</button></td></tr>`);
        });
    }

    connectWS();
    updateFunding(); setInterval(updateFunding, 15000);
</script>
</body>
</html>
