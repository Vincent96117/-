<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡èƒ½ç›£æ§-å°ˆæ¥­å„ªåŒ–ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; background: #0b0e11; color: #eaecef; padding: 15px; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2b3139; padding-bottom: 15px; }
        .refresh-btn { background: #f0b90b; color: #000; border: none; padding: 15px 25px; border-radius: 10px; font-weight: bold; font-size: 18px; cursor: pointer; }
        .refresh-btn:disabled { background: #474d57; color: #848e9c; }
        .grid { display: flex; gap: 15px; flex-direction: column; }
        @media (min-width: 992px) { .grid { flex-direction: row; } }
        .column { flex: 1; background: #181a20; padding: 15px; border-radius: 12px; border: 1px solid #2b3139; margin-top: 15px; }
        .col-title { color: #f0b90b; font-size: 18px; font-weight: bold; border-left: 5px solid #f0b90b; padding-left: 10px; margin-bottom: 5px; }
        .col-desc { color: #848e9c; font-size: 12px; margin-bottom: 15px; padding-left: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #848e9c; font-size: 12px; border-bottom: 1px solid #2b3139; padding: 8px 5px; }
        td { padding: 10px 5px; border-bottom: 1px solid #2b3139; font-size: 14px; }
        .symbol { color: #f0b90b; font-weight: bold; }
        .up { color: #02c076; font-weight: bold; }
        .down { color: #f84960; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="margin:0; font-size: 20px;">ğŸ“Š é‡èƒ½ç›£æ§ (éæ¿¾æ–°å¹£+ç›¤æ•´ç‰ˆ)</h1>
        <button id="btn" class="refresh-btn" onclick="run()">ğŸ”„ åˆ·æ–°</button>
    </div>
    <div id="status" style="text-align:center; color:#f0b90b; margin: 10px 0; font-size: 14px;">æ’é™¤ä¸Šå¸‚æœªæ»¿ 30 å¤©ä¹‹å¹£ç¨®</div>
    
    <div class="grid">
        <div class="column">
            <div class="col-title">âš¡ çŸ­ç·šçˆ†ç™¼ (30M)</div>
            <div class="col-desc">è¿‘ 30 åˆ†é˜æˆäº¤é‡ç•°å‹•ï¼Œé©åˆè¿½çªç ´</div>
            <table>
                <thead><tr><th>å¹£ç¨®</th><th>é‡æ¯”</th><th>æ—¥å…§</th></tr></thead>
                <tbody id="sBody"></tbody>
            </table>
        </div>
        <div class="column">
            <div class="col-title">ğŸ§ª æ½›åŠ›å¸ç±Œ (8H)</div>
            <div class="col-desc">é•·ç·šé‡å¢ + ä½ä½æ©«ç›¤ï¼Œæ’é™¤å™´å®Œå›è½</div>
            <table>
                <thead><tr><th>å¹£ç¨®</th><th>é‡æ¯”</th><th>æ—¥å…§</th></tr></thead>
                <tbody id="lBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function getData(s) {
            try {
                // å¢åŠ  limit åˆ° 720 å°æ™‚ä»¥åˆ¤æ–·æ˜¯å¦ç‚ºæ–°å¹£
                const [h, m, t] = await Promise.all([
                    fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=720`).then(r => r.json()),
                    fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=5m&limit=100`).then(r => r.json()),
                    fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r => r.json())
                ]);

                // éæ¿¾æ¢ä»¶ 1ï¼šæ’é™¤ä¸Šå¸‚æœªæ»¿ 30 å¤© (720æ ¹å°æ™‚K) çš„å¹£
                if (h.length < 720) return null;

                const base = h.slice(-72).map(k => parseFloat(k[7])).reduce((a,b)=>a+b,0) / 72 / 12;
                const vols = m.map(k => parseFloat(k[7]));
                const chg = parseFloat(t.priceChangePercent);
                const highPrice = parseFloat(t.highPrice);
                const curPrice = parseFloat(t.lastPrice);
                const lowPrice = parseFloat(t.lowPrice);

                const rS = (vols.slice(-6).reduce((a,b)=>a+b,0)/6)/base;
                const rL = (vols.reduce((a,b)=>a+b,0)/100)/base;

                // ç›¤æ•´å¸ç±Œåˆ¤æ–·ï¼šåƒ¹æ ¼ç›®å‰åœ¨ç•¶å¤©é«˜ä½é»çš„ 60% ä»¥ä¸‹ (ä»£è¡¨æ²’åœ¨å™´) ä¸”å›æ’¤ä¸è¶…éæ—¥å…§é«˜é»å¤ªé 
                const pricePos = (curPrice - lowPrice) / (highPrice - lowPrice);
                const isConsolidating = pricePos < 0.6; 

                return { s, rS, rL, chg, isConsolidating };
            } catch(e) { return null; }
        }

        async function run() {
            const btn = document.getElementById('btn'); btn.disabled = true;
            const status = document.getElementById('status');
            const info = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r => r.json());
            const list = info.symbols.filter(s => s.quoteAsset === 'USDT' && s.contractType === 'PERPETUAL').map(s => s.symbol);
            
            let sRes = [], lRes = [];
            for (let i = 0; i < list.length; i += 25) {
                status.innerText = `ğŸ” æƒæä¸­: ${i}/${list.length}`;
                const batch = await Promise.all(list.slice(i, i + 25).map(s => getData(s)));
                batch.forEach(r => { 
                    if(r){ 
                        if(r.rS > 2.5) sRes.push(r); 
                        // å³æ¬„ï¼šé‡èƒ½å€ç‡ > 1.8 ä¸” æ­£åœ¨ä½ä½æ©«ç›¤ ä¸” æ—¥å…§æ¼²å¹…ä¸å¤§
                        if(r.rL > 1.8 && r.isConsolidating && r.chg < 5) lRes.push(r); 
                    } 
                });
            }

            const fmt = (c) => `<span class="${c>=0?'up':'down'}">${c>=0?'+':''}${c.toFixed(2)}%</span>`;
            document.getElementById('sBody').innerHTML = sRes.sort((a,b)=>b.rS-a.rS).map(r => `<tr><td class="symbol">${r.s}</td><td>${r.rS.toFixed(1)}x</td><td>${fmt(r.chg)}</td></tr>`).join('') || "<tr><td colspan='3'>ç„¡è¨Šè™Ÿ</td></tr>";
            document.getElementById('lBody').innerHTML = lRes.sort((a,b)=>b.rL-a.rL).map(r => `<tr><td class="symbol">${r.s}</td><td>${r.rL.toFixed(1)}x</td><td>${fmt(r.chg)}</td></tr>`).join('') || "<tr><td colspan='3'>ç„¡è¨Šè™Ÿ</td></tr>";
            status.innerText = "âœ… æƒæå®Œæˆ - å·²æ’é™¤æ–°å¹£èˆ‡å›è½å¹£";
            btn.disabled = false;
        }
        run();
    </script>
</body>
</html>
