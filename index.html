<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HUNTER PRO | V98 å¯¦æ™‚ç›£æ§</title>
    <style>
        :root { --bg: #000; --card: #111; --border: #333; --text: #eee; --surge: #3fb950; --fall: #f85149; --strong: #58a6ff; --alert: #ff6600; --double: #f2a900; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; font-size: 11px; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .top-calendar { height: 75px; background: #000; border-bottom: 2px solid #444; display: flex; flex-direction: column; }
        .cal-header { background: #161b22; padding: 3px 10px; color: #888; display: flex; justify-content: space-between; border-bottom: 1px solid #333; }
        .cal-scroll { flex: 1; overflow-x: auto; display: flex; align-items: center; padding: 0 10px; gap: 20px; white-space: nowrap; }
        .cal-item { display: flex; flex-direction: column; border-left: 2px solid var(--strong); padding-left: 8px; }
        .cal-time { color: #888; font-size: 10px; }
        .cal-event { color: #fff; font-weight: bold; font-size: 11px; }
        .header-main { display: flex; align-items: center; justify-content: space-between; background: #161b22; padding: 2px 12px; height: 30px; border-bottom: 1px solid var(--border); }
        .container { display: grid; grid-template-columns: 0.9fr 0.9fr 1fr 1.6fr; gap: 4px; flex: 1; padding: 4px; box-sizing: border-box; overflow: hidden; }
        .card { background: #0d1117; border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; overflow: hidden; }
        h2 { font-size: 0.8rem; padding: 5px; margin: 0; background: #161b22; border-bottom: 1px solid var(--border); text-align: center; }
        .scroll { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        td { padding: 6px 2px; border-bottom: 1px solid #21262d; text-align: center; vertical-align: middle; }
        .status-tag { font-size: 9px; color: #888; display: block; margin-top: 2px; }
        .funding-high { background: #a6611a !important; color: white !important; font-weight: bold; }
        .funding-tag { font-size: 9px; padding: 1px 3px; border-radius: 2px; margin-left: 2px; }
        .double-tag { color: var(--double); font-weight: bold; }
        .pot-alert { animation: blink-red 1s infinite; border: 1px solid var(--fall) !important; }
        @keyframes blink-red { 0% { background: transparent; } 50% { background: #f8514933; } 100% { background: transparent; } }
        /* 08:00 æ–°å¢æ¨£å¼ */
        .snap-group { border-left: 3px solid #444; margin-bottom: 2px; background: #161b22; }
        .snap-title { background: #222; font-size: 9px; padding: 2px 5px; color: #aaa; font-weight: bold; }
        .up { color: var(--surge); } .down { color: var(--fall); }
    </style>
</head>
<body>

<div class="top-calendar">
    <div class="cal-header"><span>ğŸ“… USD é‡è¦æ—¥æ›†</span><span id="cal-status">OK</span></div>
    <div class="cal-scroll" id="calendar-content"></div>
</div>

<div class="header-main">
    <div style="font-weight:bold; font-size:12px;">
        <span style="color:#f2a900">BTC: <span id="btc-live">--</span></span> | <span style="color:#627eea">ETH: <span id="eth-live">--</span></span>
    </div>
    <div style="color:var(--strong); font-weight:bold; letter-spacing: 1px;">HUNTER PRO | å¯¦æ™‚ç›¤é¢å°æ¨™ç³»çµ±</div>
    <button onclick="location.reload()" style="cursor:pointer; font-size:10px; background: #333; color: #fff; border: 1px solid #555; padding: 2px 8px; border-radius: 3px;">ğŸ”„ ç³»çµ±é‡æ•´</button>
</div>

<div class="container">
    <div class="card"><h2 style="color:var(--surge)">ğŸš€ ç¬é–“å™´ç™¼</h2><div class="scroll"><table><tbody id="surge-list"></tbody></table></div></div>
    <div class="card"><h2 style="color:var(--strong)">ğŸ”¥ é«˜æª”å¼·å‹¢</h2><div class="scroll"><table><tbody id="strong-list"></tbody></table></div></div>
    
    <div class="card">
        <h2 style="color:var(--fall)">âš ï¸ è³‡é‡‘è²»ç‡ (>=0.05)</h2>
        <div style="height: 30%; border-bottom: 2px solid #333;" class="scroll"><table><tbody id="fund-list"></tbody></table></div>
        <h2 style="color:var(--double)">â±ï¸ 08:00 æ ¸å¿ƒæˆ°æœå›æº¯</h2>
        <div id="snap-list" class="scroll" style="background: #050505;"></div>
    </div>
    
    <div class="card">
        <h2 style="color:#bc8cff">ğŸ’ æ ¸å¿ƒé‡èƒ½ç›£æ§</h2>
        <div style="height: 48%;" class="scroll"><table id="table-old"></table></div>
        <div class="split-line" style="height:2px;background:#444"></div>
        <h2 style="color:#58a6ff">ğŸŒ€ è¶¨å‹¢æ”¾é‡ç›£æ§</h2>
        <div style="height: 48%;" class="scroll"><table id="table-new"></table></div>
    </div>
</div>

<script>
    const MY_BARK_KEY = 'KQP2fTbTfPp4HnhQSYNaxH';
    let btcChange = 0, fundingMap = {}, dataMap = {}, potOld = [], potNew = [], snapshotData = [];
    let strongSet = new Set(), pushedSet = new Set();

    function sendPush(title, content) {
        const url = `https://api.day.app/${MY_BARK_KEY}/${encodeURIComponent(title)}/${encodeURIComponent(content)}?group=Hunter&sound=calypso`;
        fetch(url, { mode: 'no-cors' });
    }

    async function fetchCalendar() {
        try {
            const res = await fetch('https://nfs.faireconomy.media/ff_calendar_thisweek.json');
            const data = await res.json();
            const container = document.getElementById('calendar-content'); container.innerHTML = '';
            data.filter(e => e.country === 'USD' && e.impact === 'High').slice(0, 8).forEach(e => {
                const date = new Date(e.date);
                container.insertAdjacentHTML('beforeend', `<div class="cal-item"><div class="cal-time">${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}</div><div class="cal-event">${e.title}</div></div>`);
            });
        } catch (e) {}
    }

    async function getBaseVolume(symbol) {
        try {
            const res = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}USDT&interval=4h&limit=18`);
            const data = await res.json();
            let t = 0; data.forEach(k => t += parseFloat(k[7])); return t / data.length;
        } catch(e) { return 5000000; }
    }

    async function updateFunding() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
            const data = await res.json();
            const list = document.getElementById('fund-list'); list.innerHTML = '';
            data.forEach(f => { fundingMap[f.symbol.replace('USDT','')] = parseFloat(f.lastFundingRate)*100; });
            data.filter(f => Math.abs(parseFloat(f.lastFundingRate)*100) >= 0.05).sort((a,b) => Math.abs(parseFloat(b.lastFundingRate))-Math.abs(parseFloat(a.lastFundingRate))).slice(0,10).forEach(f => {
                list.insertAdjacentHTML('beforeend', `<tr><td>${f.symbol.replace('USDT','')}</td><td class="funding-high">${(parseFloat(f.lastFundingRate)*100).toFixed(4)}%</td></tr>`);
            });
        } catch(e) {}
    }

    async function fetchSnapshot() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const data = await res.json();
            snapshotData = data.filter(d => d.symbol.endsWith('USDT')).map(d => {
                const s = d.symbol.replace('USDT','');
                const vol = parseFloat(d.quoteVolume);
                const p24 = parseFloat(d.priceChangePercent);
                // æ¨¡æ“¬ V96 æ ¸å¿ƒè©•åˆ†é‚è¼¯ (é‡èƒ½æ¬Šé‡)
                let score = 0;
                if(vol > 8000000) score = Math.min(100, Math.round(((p24 > 0 ? p24*10 : 0) + 30)));
                return { s, open: parseFloat(d.openPrice), score };
            });
            renderSnapshot();
        } catch (e) {}
    }

    function renderSnapshot() {
        const container = document.getElementById('snap-list'); container.innerHTML = '';
        const groups = [
            { label: 'ğŸ’ æ ¸å¿ƒå¼·å‹¢ (80+)', min: 80, color: '#bc8cff' },
            { label: 'âš¡ æ½›åŠ›ç›£æ§ (60+)', min: 60, color: '#f2a900' },
            { label: 'ğŸ”­ è§€å¯Ÿåå–® (40+)', min: 40, color: '#58a6ff' }
        ];
        groups.forEach(g => {
            const list = snapshotData.filter(x => x.score >= g.min && x.score < (groups[groups.indexOf(g)-1]?.min || 101))
                                     .sort((a,b) => b.score - a.score).slice(0, 8);
            if(list.length > 0) {
                let html = `<div class="snap-group"><div class="snap-title" style="color:${g.color}">${g.label}</div><table style="font-size:9px;">`;
                list.forEach(it => {
                    const current = dataMap[it.s]?.lp || it.open;
                    const diff = ((current - it.open) / it.open * 100).toFixed(2);
                    html += `<tr><td style="text-align:left;padding-left:5px;">${it.s}</td><td>${it.open.toFixed(3)}â†’${current.toFixed(3)}</td><td class="${diff>=0?'up':'down'}">${diff}%</td></tr>`;
                });
                html += `</table></div>`;
                container.insertAdjacentHTML('beforeend', html);
            }
        });
    }

    function connectWS() {
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');
        ws.onmessage = async (e) => {
            const tickers = JSON.parse(e.data);
            tickers.forEach(async d => {
                if(!d.s.endsWith('USDT')) return;
                const s = d.s.replace('USDT',''), p = parseFloat(d.c), p24 = parseFloat(d.P), vol = parseFloat(d.q), h = parseFloat(d.h), l = parseFloat(d.l), range = ((h-l)/l)*100;
                if(s==='BTC') { btcChange=p24; document.getElementById('btc-live').innerText=`${p} (${p24}%)`; }
                if(s==='ETH') document.getElementById('eth-live').innerText=`${p} (${p24}%)`;
                if(!dataMap[s]) { dataMap[s] = {lp:p, avg4hVol: 0}; dataMap[s].avg4hVol = await getBaseVolume(s); }

                // --- V96 åŸæœ‰é‚è¼¯: å¼·å‹¢å€ ---
                const sl = document.getElementById('strong-list');
                let er = [...sl.querySelectorAll('tr')].find(x => x.innerHTML.includes(s));
                if (p24 > 8.0) {
                    if (!er) {
                        sl.insertAdjacentHTML('beforeend', `<tr><td>${s}</td><td style="color:var(--surge)">${p24}%</td></tr>`);
                        if(!strongSet.has(s)) { sendPush(`ğŸ”¥ é«˜æª”å¼·å‹¢æ–°å¹£: ${s}`, `æ¼²å¹…é” ${p24}%`); strongSet.add(s); }
                    } else er.cells[1].innerText = `${p24}%`;
                } else if (er) { er.remove(); strongSet.delete(s); }

                // --- V96 åŸæœ‰é‚è¼¯: ç¬æ™‚ ---
                const inst = ((p-dataMap[s].lp)/dataMap[s].lp)*100;
                if(inst>=1.2) {
                    const b = document.getElementById('surge-list');
                    b.insertAdjacentHTML('afterbegin', `<tr><td>${s}</td><td style="color:var(--surge)">+${inst.toFixed(2)}%</td></tr>`);
                    if(b.children.length>10) b.lastElementChild.remove();
                }

                // --- V96 åŸæœ‰é‚è¼¯: æ ¸å¿ƒèˆ‡è¶¨å‹¢ç­–ç•¥ ---
                if(p24 >= 1.0 && p24 <= 5.0 && range <= 6.5) {
                    const rsS = (p24 - btcChange) > 0 ? Math.min(45, (p24 - btcChange) * 11) : 0;
                    const sqS = Math.max(0, Math.min(30, (6.5 - range) * 4.6));
                    const volRatio = (vol / 6) / dataMap[s].avg4hVol;
                    const desc = `${p24>btcChange?'è¶…ç›¤':'éš¨ç›¤'} | ç¸®${range.toFixed(1)}% | ${volRatio.toFixed(1)}x`;
                    const scoreCore = (vol > 8000000) ? Math.min(100, Math.round(rsS + sqS + Math.min(25, (vol/10000000)*5) + 5)) : 0;
                    const scoreTrend = Math.min(100, Math.round(rsS + sqS + Math.min(25, (volRatio / 1.5) * 12)));

                    if(scoreCore >= 20) {
                        updateList(potOld, {s, score:scoreCore, desc, isDouble:(scoreTrend>=20), type:'core'}, 'table-old');
                        potNew = potNew.filter(x => x.s !== s);
                    } else { potOld = potOld.filter(x => x.s !== s); }

                    if(scoreTrend >= 20 && !potOld.find(x => x.s === s)) {
                        updateList(potNew, {s, score:scoreTrend, desc, isDouble:false, type:'trend'}, 'table-new');
                    } else if(scoreTrend < 20) { potNew = potNew.filter(x => x.s !== s); }
                }
                dataMap[s].lp=p;
            });
            renderSnapshot(); // è®“å°æ¨™å€éš¨å ±åƒ¹æ»¾å‹•
        };
    }

    function updateList(list, c, eid) {
        let item = list.find(i=>i.s===c.s);
        let isNew = false;
        if(!item) {
            isNew = true;
            if(list.length < 15) { item = c; list.push(item); }
            else if(c.score > list[list.length-1].score) { list.pop(); item = c; list.push(item); }
        }
        if(item) {
            item.score = c.score; item.desc = c.desc; item.isDouble = c.isDouble;
            if(c.type === 'core' && isNew && !pushedSet.has(item.s)) {
                sendPush(`ğŸ’ ç›£æ§ç›®æ¨™å‡ºç¾: ${item.s}`, `${item.isDouble?'[é›™é‡ç¢ºèª] ':''}${item.score}åˆ† | ${item.desc}`);
                pushedSet.add(item.s);
            }
        }
        renderTable(list, eid);
    }

    function renderTable(list, eid) {
        const dom = document.getElementById(eid); dom.innerHTML = '';
        list.sort((a,b)=>b.score-a.score).forEach(it => {
            const fr = (fundingMap[it.s] || 0).toFixed(3);
            dom.insertAdjacentHTML('beforeend', `<tr class="${it.score>=80?'pot-alert':''}">
                <td style="text-align:left; padding-left:10px;">
                    <span class="${it.isDouble?'double-tag':''}">${it.isDouble?'[é›™] ':''}${it.s}</span>
                    <span class="funding-tag ${Math.abs(fr)>=0.05?'funding-high':''}">${fr}%</span>
                    <span class="status-tag">${it.desc}</span>
                </td>
                <td style="color:var(--alert);font-weight:bold;font-size:13px;">${it.score}</td>
                <td><button style="border:none;background:transparent;color:#666;cursor:pointer" onclick="pushedSet.delete('${it.s}'); potOld=potOld.filter(x=>x.s!=='${it.s}'); potNew=potNew.filter(x=>x.s!=='${it.s}');">âœ•</button></td>
            </tr>`);
        });
    }

    fetchCalendar(); updateFunding(); fetchSnapshot(); connectWS();
    setInterval(updateFunding, 15000); setInterval(fetchSnapshot, 60000);
</script>
</body>
</html>
