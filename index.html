<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡èƒ½ç›£æ§-ç¶“å…¸é€²åº¦ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; background: #0b0e11; color: #eaecef; padding: 10px; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #2b3139; }
        .refresh-btn { background: #f0b90b; color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .refresh-btn:disabled { background: #474d57; color: #848e9c; }
        .grid { display: flex; gap: 10px; flex-direction: column; }
        @media (min-width: 992px) { .grid { flex-direction: row; } }
        .column { flex: 1; background: #181a20; padding: 15px; border-radius: 12px; border: 1px solid #2b3139; margin-top: 10px; }
        .col-title { color: #f0b90b; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .col-desc { color: #848e9c; font-size: 12px; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #848e9c; font-size: 11px; border-bottom: 1px solid #2b3139; padding: 8px 4px; }
        td { padding: 12px 4px; border-bottom: 1px solid #2b3139; font-size: 15px; }
        .symbol { color: #f0b90b; font-weight: bold; }
        .up { color: #02c076; font-weight: bold; }
        .down { color: #f84960; }
        #status { text-align: center; color: #f0b90b; font-size: 14px; padding: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0; font-size: 18px;">ğŸ“Š å°ˆæ¥­é‡èƒ½ç›£æ§</h2>
        <button id="btn" class="refresh-btn" onclick="run()">ğŸ”„ é–‹å§‹æƒæ</button>
    </div>
    <div id="status">æº–å‚™å°±ç·’</div>
    
    <div class="grid">
        <div class="column">
            <div class="col-title">âš¡ çŸ­ç·šçˆ†ç™¼ (30M)</div>
            <div class="col-desc">30åˆ†é˜å…§é‡èƒ½ç¿»å€</div>
            <table>
                <thead><tr><th>å¹£ç¨®</th><th>é‡æ¯”</th><th>æ¼²å¹…</th></tr></thead>
                <tbody id="sBody"></tbody>
            </table>
        </div>
        <div class="column">
            <div class="col-title">ğŸ“ˆ èµ·è·‘æ½›åŠ› (8H)</div>
            <div class="col-desc">ä½ä½æ”¾é‡ï¼Œæ’é™¤å™´å®Œå›è½</div>
            <table>
                <thead><tr><th>å¹£ç¨®</th><th>é‡æ¯”</th><th>æ¼²å¹…</th></tr></thead>
                <tbody id="lBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        async function getData(s) {
            try {
                // ä½¿ç”¨å‚™ç”¨æ¥å£é˜²æ­¢è¶…æ™‚
                const [h, t] = await Promise.all([
                    fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=24`).then(r => r.json()),
                    fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`).then(r => r.json())
                ]);

                if (!h || h.length < 24) return null;

                const baseVol = h.map(k => parseFloat(k[7])).reduce((a,b)=>a+b,0) / 24; // æ¯å°æ™‚å¹³å‡é‡
                const lastHourVol = parseFloat(h[h.length-1][7]);
                const chg = parseFloat(t.priceChangePercent);
                const curPrice = parseFloat(t.lastPrice);
                const high = parseFloat(t.highPrice);
                const low = parseFloat(t.lowPrice);

                const ratio = lastHourVol / baseVol;
                const pricePos = (curPrice - low) / (high - low);

                return { s, ratio, chg, pricePos };
            } catch(e) { return null; }
        }

        async function run() {
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            btn.disabled = true;
            
            // ç²å–å¹£ç¨®åˆ—è¡¨
            const info = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r => r.json());
            const list = info.symbols.filter(s => s.quoteAsset === 'USDT' && s.contractType === 'PERPETUAL').map(s => s.symbol);
            
            let sRes = [], lRes = [];
            const batchSize = 10; // å°æ‰¹é‡ï¼Œé˜²æ­¢è¶…æ™‚

            for (let i = 0; i < list.length; i += batchSize) {
                status.innerText = `ğŸ” æ­£åœ¨æƒæ: ${i} / ${list.length} (${Math.round(i/list.length*100)}%)`;
                const batch = await Promise.all(list.slice(i, i + batchSize).map(s => getData(s)));
                
                batch.forEach(r => {
                    if(r) {
                        // å·¦é‚Šï¼šçˆ†ç™¼ (é‡æ¯” > 2.0)
                        if(r.ratio > 2.0) sRes.push(r);
                        // å³é‚Šï¼šèµ·è·‘ (é‡æ¯” > 1.2 ä¸” åƒ¹æ ¼åœ¨ä½ä½ 40% ä»¥ä¸‹ ä¸” æ¼²å¹… < 4%)
                        if(r.ratio > 1.2 && r.pricePos < 0.4 && r.chg > 0 && r.chg < 4) lRes.push(r);
                    }
                });
                // æ¯æ¬¡è«‹æ±‚é–“éš” 0.1 ç§’ï¼Œä¿è­·é€£ç·šä¸ä¸­æ–·
                await sleep(100);
            }

            const fmt = (c) => `<span class="${c>=0?'up':'down'}">${c>=0?'+':''}${c.toFixed(2)}%</span>`;
            const render = (items) => items.sort((a,b)=>b.ratio-a.ratio).slice(0, 15).map(r => `
                <tr>
                    <td class="symbol">${r.s.replace('USDT','')}</td>
                    <td style="color:#02c076; font-weight:bold;">${r.ratio.toFixed(1)}x</td>
                    <td>${fmt(r.chg)}</td>
                </tr>`).join('');

            document.getElementById('sBody').innerHTML = render(sRes) || "<tr><td colspan='3'>ç„¡è¨Šè™Ÿ</td></tr>";
            document.getElementById('lBody').innerHTML = render(lRes) || "<tr><td colspan='3'>ç„¡è¨Šè™Ÿ</td></tr>";
            
            status.innerText = "âœ… æƒæå®Œæˆï¼æœ€å¾Œæ›´æ–°: " + new Date().toLocaleTimeString();
            btn.disabled = false;
        }

        run();
    </script>
</body>
</html>
