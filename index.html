<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é‡èƒ½ç›£æ§ V51 - æˆ°è¡“æ¸…å–®ç®¡ç†</title>
    <style>
        body { font-family: sans-serif; background: #0b0e11; color: #eaecef; padding: 10px; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .column { background: #181a20; padding: 15px; border-radius: 12px; border: 1px solid #2b3139; min-height: 650px; }
        .col-title { color: #f0b90b; font-size: 16px; font-weight: bold; margin-bottom: 10px; border-left: 4px solid #f0b90b; padding-left: 8px; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 8px 5px; border-bottom: 1px solid #2b3139; font-size: 12px; }
        .symbol { color: #f0b90b; font-weight: bold; font-size: 14px; }
        .up { color: #02c076; font-weight: bold; }
        .accum-up { background: #02c076; color: #fff; padding: 2px 4px; border-radius: 3px; font-size: 10px; }
        .tag-awake { background: rgba(240, 185, 11, 0.2); color: #f0b90b; padding: 2px 4px; border-radius: 4px; font-size: 10px; }
        
        /* ç¬¬å››æ¬„å°ˆç”¨ */
        .breakout { background: rgba(58, 110, 255, 0.3) !important; transition: 0.3s; }
        .del-btn { color: #f84960; cursor: pointer; font-weight: bold; padding: 0 5px; font-size: 14px; border: 1px solid #f84960; border-radius: 3px; margin-left: 5px; }
        .del-btn:hover { background: #f84960; color: white; }
        .tag-fire { background: #3a6eff; color: white; padding: 1px 4px; border-radius: 3px; font-weight: bold; font-size: 10px; }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; padding:10px; align-items: center;">
        <h2 style="margin:0; font-size: 18px;">ğŸ“Š å°ˆæ¥­ç›£æ§ V51 (æˆ°è¡“æ¸…å–®ç®¡ç†)</h2>
        <div id="timer" style="color:#848e9c;">5s åˆ·æ–°</div>
    </div>
    
    <div class="grid">
        <div class="column"><div class="col-title">âš¡ ç¬é–“å™´ç™¼ (å ±è­¦)</div><table><tbody id="instantBody"></tbody></table></div>
        <div class="column"><div class="col-title">ğŸ”¥ é«˜æª”å¼·å‹¢ (æ’ä½)</div><table><tbody id="trendBody"></tbody></table></div>
        <div class="column"><div class="col-title">ğŸ“ˆ ç›¤æ•´é‡å¢ (2H)</div><table><tbody id="sidewaysBody"></tbody></table></div>
        <div class="column">
            <div class="col-title">ğŸ’ ä½ä½è½‰æŠ˜æ¸…å–® (ä¸Šé™15)</div>
            <div style="font-size:10px; color:#848e9c; margin-bottom:5px;">æ‰‹å‹•åˆªé™¤ä¸å–œæ­¡çš„æ¨™çš„ï¼Œæ–°å¹£æœƒè‡ªå‹•è£œä½</div>
            <table><tbody id="pivotBody"></tbody></table>
        </div>
    </div>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="tingSound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <script>
        let lastPrices = new Map(), firstDetectedPrices = new Map(), maxPriceRecorded = new Map();
        let burstHistory = [];
        let manualPivotList = []; // ç¬¬å››æ¬„å›ºå®šæ¸…å–®
        let blacklist = new Set(); // æš«æ™‚éæ¿¾æ‰ä¸æƒ³çœ‹çš„
        let timeLeft = 5;

        // æ¨¡æ“¬ MA è¨ˆç®—
        function getSimulatedMA(price, change24h) {
            let estOpen = price / (1 + change24h/100);
            return (price + estOpen) / 2;
        }

        // æ‰‹å‹•åˆªé™¤åŠŸèƒ½
        function removeSymbol(s) {
            manualPivotList = manualPivotList.filter(item => item.s !== s);
            blacklist.add(s); // åŠ å…¥é»‘åå–®ï¼Œé¿å…ä¸‹ä¸€ç§’åˆ·æ–°åˆè·‘å‡ºä¾†
            renderPivot();
        }

        async function run() {
            try {
                const resp = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
                const tickers = await resp.json();
                let trendRes = [], awakeRes = [];
                let now = Date.now();
                let playBurst = false, playTing = false;

                tickers.filter(t => t.symbol.endsWith('USDT') && !t.symbol.includes('_')).forEach(t => {
                    const symbol = t.symbol.replace('USDT', '');
                    const curP = parseFloat(t.lastPrice);
                    const chg24 = parseFloat(t.priceChangePercent);
                    const vol24h = parseFloat(t.quoteVolume);
                    const high = parseFloat(t.highPrice);
                    
                    // 1. åŸºç¤æ•¸æ“šæ›´æ–°
                    let secChg = lastPrices.has(symbol) ? ((curP - lastPrices.get(symbol)) / lastPrices.get(symbol)) * 100 : 0;
                    lastPrices.set(symbol, curP);

                    // 2. å·¦ä¸€ï¼šç¬é–“å™´ç™¼
                    if (secChg >= 0.45 && vol24h > 5000000) {
                        if (!firstDetectedPrices.has(symbol)) { firstDetectedPrices.set(symbol, curP); maxPriceRecorded.set(symbol, curP); playBurst = true; }
                        else if (curP > (maxPriceRecorded.get(symbol) || 0)) { maxPriceRecorded.set(symbol, curP); playBurst = true; }
                        burstHistory = burstHistory.filter(i => i.s !== symbol);
                        burstHistory.unshift({ s: symbol, c: secChg, ts: now });
                        if (burstHistory.length > 10) burstHistory.pop();
                    }

                    // 3. å·¦äºŒï¼šé«˜æª”å¼·å‹¢
                    if (chg24 > 5.0 && (high - curP)/high < 0.015) trendRes.push({ s: symbol, c: chg24 });

                    // 4. å·¦ä¸‰ï¼šç›¤æ•´é‡å¢
                    const realB = (vol24h / 450) / (vol24h / 1440);
                    if (Math.abs(chg24) < 3.5 && realB > 1.1) awakeRes.push({ s: symbol, b: realB });

                    // 5. å³ä¸€ï¼šä½ä½éº»èŠ±é‚è¼¯
                    let ma7 = getSimulatedMA(curP, chg24), ma25 = getSimulatedMA(curP, chg24), ma99 = getSimulatedMA(curP, chg24);
                    let maGap = (Math.max(ma7, ma25, ma99) / Math.min(ma7, ma25, ma99) - 1) * 100;
                    
                    // å¦‚æœç¬¦åˆéº»èŠ±æ¢ä»¶ä¸”ä¸åœ¨åå–®ä¸­ã€ä¸åœ¨é»‘åå–®å…§
                    if (maGap < 1.5 && chg24 > -5 && chg24 < 3 && !blacklist.has(symbol)) {
                        let isBreakout = curP > Math.max(ma7, ma25, ma99);
                        
                        let idx = manualPivotList.findIndex(p => p.s === symbol);
                        if (idx === -1) {
                            // åå–®æœªæ»¿ 15 å‰‡åŠ å…¥
                            if (manualPivotList.length < 15) {
                                manualPivotList.push({ s: symbol, gap: maGap, breakout: isBreakout, alerted: isBreakout });
                                if (isBreakout) playTing = true;
                            }
                        } else {
                            // å·²åœ¨åå–®ä¸­ï¼Œæ›´æ–°ç‹€æ…‹
                            let item = manualPivotList[idx];
                            if (isBreakout && !item.alerted) { playTing = true; item.alerted = true; }
                            item.gap = maGap;
                            item.breakout = isBreakout;
                        }
                    }
                });

                if (playBurst) document.getElementById('alertSound').play().catch(()=>{});
                if (playTing && !playBurst) document.getElementById('tingSound').play().catch(()=>{});

                // æ¸²æŸ“å‰ä¸‰æ¬„
                renderBasics(trendRes, awakeRes);
                renderPivot();
                
            } catch (e) { console.error(e); }
        }

        function renderBasics(trendRes, awakeRes) {
            document.getElementById('instantBody').innerHTML = burstHistory.map(r => {
                const startP = firstDetectedPrices.get(r.s) || 0;
                const accum = startP > 0 ? ((lastPrices.get(r.s) - startP) / startP * 100) : 0;
                return `<tr><td class="symbol">${r.s}</td><td class="up" align="right">+${r.c.toFixed(2)}%</td><td align="right"><span class="accum-up">çºŒ:${accum.toFixed(2)}%</span></td></tr>`;
            }).join('');
            document.getElementById('trendBody').innerHTML = trendRes.sort((a,b)=>b.c-a.c).slice(0,10).map(r => `<tr><td class="symbol">${r.s}</td><td class="up" align="right">+${r.c.toFixed(1)}%</td></tr>`).join('');
            document.getElementById('sidewaysBody').innerHTML = awakeRes.sort((a,b)=>b.b-a.b).slice(0,10).map(r => `<tr><td class="symbol">${r.s}</td><td align="right"><span class="tag-awake">${r.b.toFixed(1)}x é‡</span></td></tr>`).join('');
        }

        function renderPivot() {
            document.getElementById('pivotBody').innerHTML = manualPivotList.map(r => `
                <tr class="${r.breakout ? 'breakout' : ''}">
                    <td class="symbol">${r.s} <span class="del-btn" onclick="removeSymbol('${r.s}')">Ã—</span></td>
                    <td style="color:#848e9c; font-size:10px;">æ“ :${r.gap.toFixed(1)}%</td>
                    <td align="right">${r.breakout ? '<span class="tag-fire">çªç ´</span>' : '<span style="color:#848e9c">å£“ç¸®ä¸­</span>'}</td>
                </tr>`).join('');
        }

        setInterval(() => { if (--timeLeft <= 0) { timeLeft=5; run(); } document.getElementById('timer').innerText = timeLeft + "s åˆ·æ–°"; }, 1000);
        run();
    </script>
</body>
</html>
