<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>HUNTER PRO | V144 è‡ªå‹•æ’åºç‰ˆ</title>
    <style>
        body { background: #000; color: #eee; font-family: 'Segoe UI', sans-serif; padding: 20px; font-size: 13px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #1c1c1c; padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        .control-panel { display: flex; gap: 10px; margin-bottom: 20px; background: #252525; padding: 15px; border-radius: 8px; align-items: center; }
        input { background: #333; border: 1px solid #555; color: #fff; padding: 8px; border-radius: 4px; outline: none; width: 150px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #333; padding: 12px; text-align: center; }
        th { background: #252525; color: #f2a900; cursor: pointer; }
        .row-tangling { background: rgba(255, 68, 68, 0.15) !important; }
        .row-weak { opacity: 0.6; } 
        .score-box { background: #444; color: #fff; padding: 4px 10px; border-radius: 3px; font-weight: bold; font-size: 15px; }
        .score-100 { background: linear-gradient(45deg, #f2a900, #ff5500); box-shadow: 0 0 10px #ff5500; }
        .btn { background: #f2a900; color: #000; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-del { background: #ff4444; color: #fff; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .tag-weak { color: #ff6666; font-size: 10px; display: block; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <span style="font-size: 20px; font-weight: bold; color: #f2a900;">ğŸ¯ V144 è‡ªå‹•æ’åºæ§ç›¤ç³»çµ±</span>
            <span id="update-time" style="margin-left: 15px; color: #888;"></span>
        </div>
        <button class="btn" onclick="toggleMonitor()" id="btn-toggle">ğŸ“¡ å•Ÿå‹•è‡ªå‹•æƒæ</button>
    </div>

    <div class="control-panel">
        <span>ğŸ” æœå°‹ä¸¦åŠ å…¥è¿½è¹¤ï¼š</span>
        <input type="text" id="search-input" placeholder="ä¾‹å¦‚: SOL">
        <button class="btn" onclick="addSearchSymbol()">åŠ å…¥åˆ†æ</button>
        <span id="status-msg" style="margin-left: 10px; color: #00ffcc;"></span>
    </div>

    <table>
        <thead>
            <tr>
                <th>é¡å‹</th>
                <th>å¹£ç¨®</th>
                <th>ç¶œåˆè©•åˆ† (é«˜â†“ä½)</th>
                <th>æ•¸æ“š (æ³¢/é‡/è·é«˜)</th>
                <th>è³‡è²» (Â±0.05)</th>
                <th>24H æ¼²è·Œ</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="list-body"></tbody>
    </table>

<script>
    let isMonitoring = false;
    let timer = null;
    let userWatchlist = new Set(); // å­˜æ”¾æ‰‹å‹•æœå°‹è¦å¼·åˆ¶è¿½è¹¤çš„å¹£
    let userBlacklist = new Set(); // å­˜æ”¾æ‰‹å‹•åˆªé™¤çš„å¹£
    const EXCLUDE_LIST = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT', 'ADAUSDT'];

    function toggleMonitor() {
        isMonitoring = !isMonitoring;
        document.getElementById('btn-toggle').innerText = isMonitoring ? "ğŸ›‘ åœæ­¢ç›£æ§" : "ğŸ“¡ å•Ÿå‹•æƒæ";
        document.getElementById('btn-toggle').style.background = isMonitoring ? "#ff4444" : "#f2a900";
        if(isMonitoring) { startScan(); timer = setInterval(startScan, 15000); }
        else { clearInterval(timer); }
    }

    // åŠ å…¥æœå°‹å¹£ç¨®
    function addSearchSymbol() {
        let s = document.getElementById('search-input').value.trim().toUpperCase();
        if(!s) return;
        if(!s.endsWith('USDT')) s += 'USDT';
        userWatchlist.add(s);
        userBlacklist.delete(s); // å¦‚æœåœ¨é»‘åå–®ä¸­å‰‡ç§»é™¤
        document.getElementById('status-msg').innerText = `å·²åŠ å…¥ ${s} è¿½è¹¤`;
        if(isMonitoring) startScan();
    }

    // åˆªé™¤æŒ‰éˆ•
    function deleteSymbol(s) {
        userBlacklist.add(s + "USDT");
        userWatchlist.delete(s + "USDT");
        startScan();
    }

    const getMA = (arr, p) => arr.length < p ? 0 : arr.slice(-p).reduce((a, b) => a + b, 0) / p;

    async function calculateScore(s, quoteVolume) {
        try {
            const hK = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=25`).then(r=>r.json());
            const open = parseFloat(hK[24][1]);
            const high = parseFloat(hK[24][2]);
            const low = parseFloat(hK[24][3]);
            const now = parseFloat(hK[24][4]);
            const hCloses = hK.map(k=>parseFloat(k[4]));
            const ma7 = getMA(hCloses, 7);
            const ma25 = getMA(hCloses, 25);
            
            // æ³¢å‹•çˆ†ç™¼
            const ranges = hK.map(k => parseFloat(k[2]) - parseFloat(k[3]));
            const avgR = ranges.slice(0, 24).reduce((a,b)=>a+b,0) / 24;
            const vRatio = (high - low) / (avgR || 0.0001);
            let vScore = Math.min(25, (vRatio / 2) * 25);

            // ç³¾çµåº¦
            const hDiff = Math.abs(ma7 - ma25) / ma25 * 100;
            let tangleScore = (hDiff < 3) ? (25 * (1 - hDiff/3)) : 0;

            // é‡æ¯” (é‡å°å±±å¯¨å¹£å„ªåŒ–)
            const qRatio = (parseFloat(quoteVolume) / 25000000);
            let qScore = Math.min(25, qRatio * 10);

            // è·é«˜ 2%
            const recentH = Math.max(...hK.slice(-4).map(k=>parseFloat(k[2])));
            const distToH = Math.abs(now - recentH) / recentH * 100;
            let hScore = (distToH <= 2) ? 25 : (distToH <= 4 ? 10 : 0);

            let isWeak = (now < open || now < ma7);
            let finalScore = Math.round(vScore + tangleScore + qScore + hScore + (isWeak ? -20 : 10));

            return { score: Math.max(0, finalScore), isWeak, info: `æ³¢:${vRatio.toFixed(1)}x|é‡:${qRatio.toFixed(1)}x|è·é«˜:${distToH.toFixed(1)}%` };
        } catch(e) { return null; }
    }

    async function startScan() {
        try {
            const [tRes, fRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'),
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            const tData = await tRes.json();
            const fData = await fRes.json();
            const fundingMap = {};
            fData.forEach(f => { fundingMap[f.symbol] = parseFloat(f.lastFundingRate * 100).toFixed(4); });

            // åŸºç¤æ± ï¼šæˆäº¤é‡å¤§æ–¼ 15M çš„å¹£ + ä½¿ç”¨è€…æ‰‹å‹•è¿½è¹¤çš„å¹£
            let baseSymbols = tData.filter(d => 
                d.symbol.endsWith('USDT') && 
                !EXCLUDE_LIST.includes(d.symbol) && 
                !userBlacklist.has(d.symbol) &&
                (parseFloat(d.quoteVolume) > 15000000 || userWatchlist.has(d.symbol))
            ).sort((a,b) => b.quoteVolume - a.quoteVolume).slice(0, 45);

            let results = [];
            for (let d of baseSymbols) {
                await new Promise(r => setTimeout(r, 35));
                const res = await calculateScore(d.symbol, d.quoteVolume);
                if (res && (res.score > 30 || userWatchlist.has(d.symbol))) {
                    results.push({
                        symbol: d.symbol.replace('USDT',''),
                        score: res.score,
                        isWeak: res.isWeak,
                        info: res.info,
                        funding: fundingMap[d.symbol] || 0,
                        isTangling: (fundingMap[d.symbol] >= -0.05 && fundingMap[d.symbol] <= 0.05),
                        change: d.priceChangePercent
                    });
                }
            }

            // --- æ ¸å¿ƒæ’åºé‚è¼¯ ---
            results.sort((a, b) => {
                // 1. è³‡è²»ç³¾çµ (Â±0.05) å„ªå…ˆæ’åœ¨æœ€ä¸Šé¢
                if (a.isTangling && !b.isTangling) return -1;
                if (!a.isTangling && b.isTangling) return 1;
                // 2. åŒæ¨£æ˜¯è³‡è²»ç³¾çµæˆ–åŒæ¨£ä¸æ˜¯ï¼Œå‰‡æŒ‰åˆ†æ•¸å¾é«˜åˆ°ä½æ’
                return b.score - a.score;
            });

            document.getElementById('list-body').innerHTML = results.map(r => `
                <tr class="${r.isTangling ? 'row-tangling' : ''} ${r.isWeak ? 'row-weak' : ''}">
                    <td style="font-weight:bold;">
                        ${r.isTangling ? 'ğŸ”¥ ç³¾çµçªç ´' : 'âš¡ è¿½è¹¤ä¸­'}
                        ${r.isWeak ? '<span class="tag-weak">âš ï¸ èµ°å¼±</span>' : ''}
                    </td>
                    <td style="font-size:14px; font-weight:bold;">${r.symbol}</td>
                    <td><span class="score-box ${r.score >= 90 ? 'score-100' : ''}">${r.score}</span></td>
                    <td style="color:#aaa; font-size:11px;">${r.info}</td>
                    <td style="color:${r.isTangling ? '#ff4444' : '#eee'}; font-weight:bold;">${r.funding}%</td>
                    <td style="color:${parseFloat(r.change)>=0 ? '#00ffcc':'#ff6666'}">${r.change}%</td>
                    <td><span class="btn-del" onclick="deleteSymbol('${r.symbol}')">âŒ åˆªé™¤</span></td>
                </tr>
            `).join('');
            document.getElementById('update-time').innerText = "æœ€å¾Œåˆ·æ–°: " + new Date().toLocaleTimeString();
        } catch (e) { console.error(e); }
    }
</script>
</body>
</html>
