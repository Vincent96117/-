<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡èƒ½ç›£æ§-å°ˆæ¥­å›æ­¸ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; background: #0b0e11; color: #eaecef; padding: 15px; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2b3139; padding-bottom: 15px; }
        .refresh-btn { background: #f0b90b; color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .grid { display: flex; gap: 15px; flex-direction: column; }
        @media (min-width: 992px) { .grid { flex-direction: row; } }
        .column { flex: 1; background: #181a20; padding: 15px; border-radius: 12px; border: 1px solid #2b3139; margin-top: 10px; }
        .col-title { color: #f0b90b; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .col-desc { color: #848e9c; font-size: 12px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #848e9c; font-size: 12px; border-bottom: 1px solid #2b3139; padding: 8px 5px; }
        td { padding: 10px 5px; border-bottom: 1px solid #2b3139; font-size: 14px; }
        .symbol { color: #f0b90b; font-weight: bold; }
        .up { color: #02c076; }
        .down { color: #f84960; }
        #status { text-align: center; color: #f0b90b; font-size: 14px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="margin:0; font-size: 20px;">ğŸ“Š é‡èƒ½ç›£æ§ V4</h1>
        <button id="btn" class="refresh-btn" onclick="run()">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
    </div>
    <div id="status">æ’é™¤æ–°å¹£ï¼Œç›£æ§å…¨å¸‚å ´ä¸­...</div>
    
    <div class="grid">
        <div class="column">
            <div class="col-title">âš¡ çŸ­ç·šçˆ†ç™¼ (30M)</div>
            <div class="col-desc">è¿‘ 30 åˆ†é˜æˆäº¤é‡ç•°å‹•ï¼Œé©åˆè¿½çªç ´</div>
            <table>
                <thead><tr><th>å¹£ç¨®</th><th>é‡æ¯”</th><th>æ¼²å¹…</th></tr></thead>
                <tbody id="sBody"></tbody>
            </table>
        </div>
        <div class="column">
            <div class="col-title">ğŸ§ª æ½›åŠ›å¸ç±Œ (8H)</div>
            <div class="col-desc">ä½ä½æ©«ç›¤ + é‡èƒ½ç·©å¢ (ä¸è¿½é«˜)</div>
            <table>
                <thead><tr><th>å¹£ç¨®</th><th>é‡æ¯”</th><th>æ¼²å¹…</th></tr></thead>
                <tbody id="lBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        async function fetchWithRetry(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url);
                    if (res.ok) return await res.json();
                } catch (e) {}
                await sleep(500);
            }
            return null;
        }

        async function getData(s) {
            const [h, m, t] = await Promise.all([
                fetchWithRetry(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=1h&limit=168`),
                fetchWithRetry(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=5m&limit=100`),
                fetchWithRetry(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${s}`)
            ]);

            if (!h || !m || !t || h.length < 168) return null;

            const baseVol = h.map(k => parseFloat(k[7])).reduce((a,b)=>a+b,0) / 168 / 12;
            const currentVols = m.map(k => parseFloat(k[7]));
            const curPrice = parseFloat(t.lastPrice);
            const highPrice = parseFloat(t.highPrice);
            const lowPrice = parseFloat(t.lowPrice);
            const chg = parseFloat(t.priceChangePercent);

            const rS = (currentVols.slice(-6).reduce((a,b)=>a+b,0)/6)/baseVol;
            const rL = (currentVols.reduce((a,b)=>a+b,0)/100)/baseVol;

            // åš´æ ¼åˆ¤å®šï¼šåƒ¹æ ¼åœ¨æ—¥å…§æ³¢å¹…çš„ 40% ä»¥ä¸‹ (åº•éƒ¨) ä¸”æ²’æœ‰å™´é
            const isBottom = ((curPrice - lowPrice) / (highPrice - lowPrice)) < 0.4;

            return { s, rS, rL, chg, isBottom };
        }

        async function run() {
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            btn.disabled = true;
            status.innerText = "ğŸ” æ­£åœ¨æ·±åº¦æƒæå…¨å¸‚å ´...";
            
            const info = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo').then(r => r.json());
            const list = info.symbols.filter(s => s.quoteAsset === 'USDT' && s.contractType === 'PERPETUAL').map(s => s.symbol);
            
            let sRes = [], lRes = [];
            const batchSize = 15;
            for (let i = 0; i < list.length; i += batchSize) {
                status.innerText = `ğŸ” æƒæé€²åº¦: ${Math.round(i/list.length*100)}%`;
                const batch = await Promise.all(list.slice(i, i + batchSize).map(s => getData(s)));
                batch.forEach(r => {
                    if(r) {
                        if(r.rS > 2.5) sRes.push(r);
                        if(r.rL > 1.5 && r.isBottom && r.chg < 4) lRes.push(r);
                    }
                });
                await sleep(150); 
            }

            const fmt = (c) => `<span class="${c>=0?'up':'down'}">${c>=0?'+':''}${c.toFixed(2)}%</span>`;
            const render = (arr, key) => arr.sort((a,b)=>b[key]-a[key]).slice(0, 15).map(r => `<tr><td class="symbol">${r.s.replace('USDT','')}</td><td>${r[key].toFixed(1)}x</td><td>${fmt(r.chg)}</td></tr>`).join('');

            document.getElementById('sBody').innerHTML = render(sRes, 'rS') || "<tr><td colspan='3'>ç„¡è¨Šè™Ÿ</td></tr>";
            document.getElementById('lBody').innerHTML = render(lRes, 'rL') || "<tr><td colspan='3'>ç„¡è¨Šè™Ÿ</td></tr>";
            status.innerText = "âœ… æƒæå®Œæˆ - " + new Date().toLocaleTimeString();
            btn.disabled = false;
        }
        run();
    </script>
</body>
</html>
