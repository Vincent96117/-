<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>V82 çµäººçµ‚æ¥µç©©å®šç‰ˆ (Trump å¢å¼·)</title>
    <style>
        :root { --bg: #000; --card: #111; --border: #333; --text: #eee; --surge: #3fb950; --fall: #f85149; --strong: #58a6ff; --alert: #ff6600; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 2px; margin: 0; font-size: 11px; overflow: hidden; width: 100vw; }
        .news-banner { background: #1a1a1a; padding: 6px 15px; border: 1px solid #444; border-radius: 4px; margin: 4px; font-size: 12px; display: flex; gap: 20px; color: #fff; height: 18px; line-height: 18px; }
        .header-main { display: flex; align-items: center; justify-content: space-between; background: #000; padding: 4px 10px; border-bottom: 1px solid var(--border); height: 32px; }
        .btc-eth-status { display: flex; gap: 12px; font-weight: bold; font-size: 12px; }
        .container { display: grid; grid-template-columns: 1fr 1.1fr 1.1fr 1.6fr; gap: 4px; height: calc(100vh - 125px); padding: 4px; box-sizing: border-box; }
        .card { background: #0d1117; border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; min-width: 0; }
        h2 { font-size: 0.8rem; padding: 8px; margin: 0; background: #161b22; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .scroll { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        td, th { padding: 6px 2px; border-bottom: 1px solid #21262d; text-align: center; }
        .news-li { padding: 8px; border-bottom: 1px solid #222; line-height: 1.4; }
        .news-time { color: #888; font-size: 9px; margin-right: 5px; font-family: monospace; }
        .trump-tag { background: #ff4444; color: #fff; padding: 1px 3px; border-radius: 2px; font-size: 9px; font-weight: bold; margin-right: 4px; }
        .refresh-btn { background: #1f6feb; color: white; border: none; padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 10px; }
        .funding-high { background: #a6611a !important; color: white !important; font-weight: bold; }
        .funding-tag { font-size: 9px; padding: 1px 3px; border-radius: 2px; margin-left: 2px; }
        @keyframes blink-red { 0% { background: transparent; } 50% { background: #f8514955; } 100% { background: transparent; } }
        .pot-alert { animation: blink-red 0.5s infinite; border: 1px solid var(--fall) !important; }
        .tool-zone { display: flex; gap: 4px; padding: 4px; background: #000; }
        .tool-card { background: #161b22; border: 1px solid #444; padding: 6px; border-radius: 4px; display: flex; align-items: center; gap: 8px; flex: 1; }
        input { background: #000; border: 1px solid #444; color: #fff; padding: 3px 6px; border-radius: 3px; font-size: 10px; }
    </style>
</head>
<body>

<div class="news-banner">
    <div><b>ğŸ“¢ å¸‚å ´ç„¦é»:</b></div>
    <marquee id="top-marquee" scrollamount="3">ç­‰å¾…å·æ™®å³æ™‚æ¶ˆæ¯é€£ç·šä¸­...</marquee>
</div>

<div class="header-main">
    <div class="btc-eth-status">
        <span id="btc-live" style="color:#f2a900">BTC: --</span>
        <span id="eth-live" style="color:#627eea">ETH: --</span>
    </div>
    <div style="font-size:10px; color:#666">æœ€å¾Œæ›´æ–°: <span id="last-update-time">--</span></div>
    <button class="refresh-btn" onclick="location.reload()">ğŸ”„ å¼·åˆ¶åˆ·æ–°</button>
</div>

<div class="container">
    <div class="card"><h2 style="color:var(--surge)">ğŸš€ ç¬é–“å™´ç™¼</h2><div class="scroll"><table><tbody id="surge-list"></tbody></table></div></div>
    
    <div class="card">
        <h2 style="color:var(--alert)">ğŸ›ï¸ å·æ™®/æ”¿ç¶“å¿«è¨Š <span id="news-count" style="font-size:9px; color:#888"></span></h2>
        <div class="scroll"><div id="trump-news-box"></div></div>
    </div>

    <div class="card"><h2 style="color:var(--fall)">âš ï¸ è³‡è²» (å‰5)</h2><div class="scroll"><table><thead><th style="width:50%">å¹£ç¨®</th><th>è³‡è²»</th></thead><tbody id="fund-list"></tbody></table></div></div>
    
    <div class="card">
        <h2 style="#bc8cff">ğŸ’ æ½›åŠ›ç›£æ§ (60/80)</h2>
        <div class="scroll"><table><thead><th style="width:40%">å¹£ç¨®(è³‡è²»)</th><th>è©•åˆ†</th><th>âœ•</th></thead><tbody id="potential-list"></tbody></table></div></div>
</div>

<div class="tool-zone">
    <div class="tool-card"><b>ğŸ Bark:</b><span id="bark-status" style="color:var(--surge)">âœ… å·²é€£ç·š (KQP2...axH)</span></div>
    <div class="tool-card">
        <b>ğŸ” é«”æª¢:</b>
        <input type="text" id="manual-symbol" placeholder="å¦‚ SOL" style="width:60px">
        <button class="refresh-btn" onclick="runCheck()">è©•åˆ†</button>
        <div id="check-result"></div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè¨­å®š ---
    const MY_BARK_KEY = 'KQP2fTbTfPp4HnhQSYNaxH';
    const NEWS_REFRESH_MS = 120000; // 2åˆ†é˜åˆ·æ–°ä¸€æ¬¡
    let lastNewsId = null;
    let btcChange = 0, fundingMap = {}, lockedPotList = [], dataMap = {}, fullTickers = [];
    let pushed60 = new Set(), pushed80 = new Set();

    // 1. æ–°èæŠ“å–é‚è¼¯
    async function fetchTrumpNews() {
        // ä½¿ç”¨å…¬å…± API ä»£ç†ä»¥ç¢ºä¿æŒçºŒæ€§ (å»ºè­°æœ‰ Key å¾Œå¡«å…¥)
        const url = `https://cryptopanic.com/api/v1/posts/?auth_token=YOUR_API_KEY&q=Trump&filter=hot&public=true`;
        
        try {
            const res = await fetch(url);
            const data = await res.json();
            if(!data.results) return;

            const box = document.getElementById('trump-news-box');
            const marquee = document.getElementById('top-marquee');
            box.innerHTML = '';
            
            let trumpHeadlines = [];
            data.results.slice(0, 15).forEach((news, index) => {
                const time = new Date(news.published_at);
                const timeStr = `${String(time.getHours()).padStart(2,'0')}:${String(time.getMinutes()).padStart(2,'0')}`;
                const isTrump = news.title.toUpperCase().includes('TRUMP');
                
                const html = `
                    <div class="news-li">
                        <span class="news-time">${timeStr}</span>
                        ${isTrump ? '<span class="trump-tag">TRUMP</span>' : ''}
                        <span style="color:${isTrump ? '#fff' : '#ccc'}">${news.title}</span>
                    </div>`;
                box.insertAdjacentHTML('beforeend', html);
                
                if(isTrump) trumpHeadlines.push(news.title);

                // 2åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼Œç™¼ç¾æ–° ID ä¸”å« Trump é—œéµå­—æ‰æ¨æ’­
                if(index === 0 && isTrump && news.id !== lastNewsId) {
                    sendBark("ğŸ›ï¸ å·æ™®æœ€æ–°å¿«è¨Š", `${timeStr} - ${news.title}`);
                    lastNewsId = news.id;
                }
            });
            
            if(trumpHeadlines.length > 0) marquee.innerText = "ğŸ”¥ å³æ™‚å‹•æ…‹: " + trumpHeadlines[0];
            document.getElementById('news-count').innerText = `(12H: ${data.results.length}å‰‡)`;
            document.getElementById('last-update-time').innerText = new Date().toLocaleTimeString();
        } catch(e) { console.log("æ–°èæ¥å£å¿™ç¢Œä¸­..."); }
    }

    // 2. Bark ç™¼é€
    async function sendBark(title, body) {
        const url = `https://api.day.app/${MY_BARK_KEY}/${encodeURIComponent(title)}/${encodeURIComponent(body)}?group=HunterV82&sound=calypso`;
        fetch(url).catch(e => {});
    }

    // 3. è³‡è²»æ›´æ–°
    async function updateFunding() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/premiumIndex');
            const data = await res.json();
            const list = document.getElementById('fund-list');
            let current = [];
            data.forEach(f => {
                const s = f.symbol.replace('USDT',''), r = parseFloat(f.lastFundingRate)*100;
                fundingMap[s] = r;
                if(Math.abs(r) >= 0.05) current.push({s, r});
            });
            list.innerHTML = '';
            current.sort((a,b) => Math.abs(b.r)-Math.abs(a.r)).slice(0,5).forEach(f => {
                list.insertAdjacentHTML('beforeend', `<tr><td>${f.s}</td><td class="funding-high">${f.r.toFixed(4)}%</td></tr>`);
            });
        } catch(e) {}
    }

    // 4. å¹£å®‰å³æ™‚é€£ç·š
    function connectWS() {
        const ws = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');
        ws.onmessage = (e) => {
            const tickers = JSON.parse(e.data); fullTickers = tickers;
            tickers.forEach(d => {
                if(d.s.endsWith('USDT')) {
                    const s = d.s.replace('USDT',''), p = parseFloat(d.c), p24 = parseFloat(d.P), vol = parseFloat(d.q), h = parseFloat(d.h), l = parseFloat(d.l), range = ((h-l)/l)*100;
                    if(s==='BTC') { btcChange=p24; document.getElementById('btc-live').innerText=`BTC: ${p} (${p24}%)`; }
                    if(s==='ETH') document.getElementById('eth-live').innerText=`ETH: ${p} (${p24}%)`;
                    
                    if(!dataMap[s]) dataMap[s]={lp:p};
                    const inst = ((p-dataMap[s].lp)/dataMap[s].lp)*100;
                    if(inst>=1.2) renderSurge(s, inst);
                    
                    if(vol > 8000000 && p24 >= 1.0 && p24 <= 5.0 && range <= 6.5) {
                        const score = calcScore(p24, vol, range);
                        updatePotentialLogic({s, score, range, p24});
                    }
                    dataMap[s].lp=p;
                }
            });
        };
        ws.onclose = () => setTimeout(connectWS, 3000);
    }

    function calcScore(p24, vol, range) {
        const rs = (p24-btcChange)>0 ? Math.min(40, (p24-btcChange)*15) : 0;
        const sq = Math.max(0, (6.5-range)*3);
        const chip = Math.min(40, (vol/12000000)*15);
        return Math.min(100, Math.round(rs+sq+chip));
    }

    function updatePotentialLogic(c) {
        let item = lockedPotList.find(i=>i.s===c.s);
        if(!item && lockedPotList.length < 10) { item = c; lockedPotList.push(item); }
        if(item) {
            item.score = c.score; 
            if(item.score >= 60 && item.score < 80 && !pushed60.has(item.s)) {
                sendBark(`ğŸ‘€ è§€å¯Ÿ: ${item.s} (${item.score}åˆ†)`, `24hæ¼²å¹…:${item.p24}%`);
                pushed60.add(item.s);
            }
            if(item.score >= 80 && !pushed80.has(item.s)) {
                sendBark(`ğŸ¯ æˆç†Ÿ: ${item.s} (${item.score}åˆ†)`, `ğŸ”¥ æº–å‚™é€²å ´é«”æª¢ï¼`);
                pushed80.add(item.s);
            }
        }
        renderPot();
    }

    function renderPot() {
        const list = document.getElementById('potential-list'); list.innerHTML = '';
        lockedPotList.forEach(item => {
            const fr = fundingMap[item.s] || 0;
            list.insertAdjacentHTML('beforeend', `<tr class="${item.score>=80?'pot-alert':''}"><td>${item.s} <span class="funding-tag ${Math.abs(fr)>=0.05?'funding-high':''}">${fr.toFixed(3)}%</span></td><td style="font-weight:bold;color:var(--alert)">${item.score}</td><td><button class="btn-del" onclick="removePot('${item.s}')">âœ•</button></td></tr>`);
        });
    }

    function removePot(s) { lockedPotList = lockedPotList.filter(i=>i.s!==s); pushed60.delete(s); pushed80.delete(s); renderPot(); }
    function renderSurge(s, i) { const b = document.getElementById('surge-list'); b.insertAdjacentHTML('afterbegin', `<tr><td>${s}</td><td style="color:var(--surge)">+${i.toFixed(2)}%</td></tr>`); if(b.children.length>10) b.lastElementChild.remove(); }
    
    function runCheck() {
        const sym = document.getElementById('manual-symbol').value.toUpperCase();
        const t = fullTickers.find(x=>x.s===sym+'USDT');
        const res = document.getElementById('check-result');
        if(!t) { res.innerText="ç„¡è³‡æ–™"; return; }
        const p24=parseFloat(t.P), vol=parseFloat(t.q), range=((parseFloat(t.h)-parseFloat(t.l))/parseFloat(t.l))*100;
        const score=calcScore(p24, vol, range);
        res.innerHTML=`<b style="color:var(--alert)">${score}åˆ†</b>`;
    }

    // å•Ÿå‹•
    sendBark("ğŸš€ çµäºº V82 å•Ÿå‹•", "åƒ¹é‡ç›£æ§èˆ‡å·æ™®å¿«è¨Šå·²å°±ç·’");
    connectWS();
    updateFunding(); setInterval(updateFunding, 10000);
    fetchTrumpNews(); setInterval(fetchTrumpNews, NEWS_REFRESH_MS);
</script>
</body>
</html>
